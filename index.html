<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GetEat - Team Lunch Management</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Modern Glassmorphism Purple Theme */
            --bg-primary: #1a0d2e;
            --bg-secondary: #2d1b4e;
            --bg-tertiary: #4c1d95;
            --bg-gradient: linear-gradient(135deg, #1a0d2e 0%, #2d1b4e 50%, #4c1d95 100%);
            
            /* Glass Surfaces */
            --surface: rgba(255, 255, 255, 0.08);
            --surface-hover: rgba(255, 255, 255, 0.12);
            --surface-glass: rgba(255, 255, 255, 0.05);
            --surface-card: rgba(139, 92, 246, 0.1);
            
            /* Borders */
            --border: rgba(255, 255, 255, 0.15);
            --border-hover: rgba(255, 255, 255, 0.25);
            --border-glass: rgba(139, 92, 246, 0.2);
            
            /* Colors */
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            
            --secondary: #06b6d4;
            --secondary-light: #67e8f9;
            --secondary-gradient: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%);
            
            --accent: #f472b6;
            --accent-light: #fbbf24;
            --accent-gradient: linear-gradient(135deg, #f472b6 0%, #fbbf24 100%);
            
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            
            /* Text */
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-accent: #a78bfa;
            
            /* Effects */
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --backdrop-blur: blur(20px);
            --backdrop-blur-strong: blur(40px);
            
            /* Shadows */
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.4);
            --shadow-glow-strong: 0 0 40px rgba(139, 92, 246, 0.6);
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;
            
            /* Border Radius */
            --radius: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 25% 25%, rgba(139, 92, 246, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(6, 182, 212, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(244, 114, 182, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .app {
            display: grid;
            grid-template-rows: 1fr auto;
            min-height: 100vh;
        }

        .main {
            padding: var(--space) var(--space) var(--space);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Admin-spezifisches Main ohne oberes Padding - Alternative für bessere Browser-Unterstützung */
        .admin-active .main {
            padding-top: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Components */
        .card {
            background: var(--surface-card);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        /* Day Cards for Voting */
        .day-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: var(--space);
            min-height: 350px;
        }

        .day-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-lg);
        }

        .day-card.day-hidden {
            opacity: 0.6;
            border: 2px dashed var(--border);
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.02) 0%,
                rgba(255, 255, 255, 0.01) 100%);
        }

        .day-card.day-hidden .day-title {
            color: var(--text-muted);
        }

        .day-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: var(--space);
            padding-bottom: var(--space);
            border-bottom: 1px solid var(--border);
        }

        .day-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .day-info {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

        .day-actions {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space);
        }

        .day-actions .btn {
            flex: 1;
            padding: 10px 16px;
            font-size: 0.875rem;
            min-height: 40px;
            font-weight: 500;
        }

        .voting-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .restaurant-vote {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space);
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .restaurant-vote:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border);
        }

        .restaurant-category {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }

        .admin-restaurant-controls {
            margin-top: var(--space);
            padding-top: var(--space);
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .btn-sm {
            padding: var(--space-xs) var(--space);
            font-size: 0.875rem;
        }

        .restaurant-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .restaurant-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            margin: 0;
        }

        .vote-count {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

        .vote-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 6px 0;
            width: 100%;
        }

        .vote-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .vote-button {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .vote-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .vote-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: var(--radius);
            border: none;
            font-family: inherit;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-glow);
            border: 1px solid var(--border-glass);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-strong);
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            color: white;
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(6, 182, 212, 0.4);
        }

        .btn-ghost {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            backdrop-filter: var(--backdrop-blur);
        }

        .btn-ghost:hover {
            background: var(--surface-hover);
            border-color: var(--border-hover);
            transform: translateY(-1px);
        }

        .input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text-primary);
            font-family: inherit;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Forms */
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
            padding: var(--space-xl);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: var(--space-lg);
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space);
            margin-bottom: var(--space);
        }

        .field {
            display: grid;
            gap: 8px;
        }

        .field label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space);
            margin-top: var(--space-lg);
        }

        .form-links {
            text-align: center;
            margin-top: var(--space);
        }

        .form-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.875rem;
        }

        .form-links a:hover {
            text-decoration: underline;
        }

        .admin-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: var(--radius);
            padding: var(--space);
            margin: var(--space) 0;
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Profile */
        .profile-header {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-xl);
        }

        .profile-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow);
            max-width: 600px;
            width: 100%;
            display: grid;
            gap: var(--space-lg);
        }

        .profile-avatar {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            margin: 0 auto;
        }

        .profile-info {
            text-align: center;
        }

        .profile-info h3 {
            margin: 0 0 var(--space-xs) 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .profile-info p {
            margin: 0 0 4px 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .profile-actions {
            display: grid;
            gap: var(--space);
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Admin Dashboard */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-sm) var(--space) var(--space);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            box-sizing: border-box;
        }

        /* Mobile Admin Dashboard */
        @media (max-width: 768px) {
            .admin-container {
                padding: var(--space-xs);
                justify-content: flex-start;
                padding-top: 80px;
            }
            
            .admin-header h2 {
                font-size: 1.5rem;
                margin-bottom: var(--space);
            }
        }

        /* Admin direkt am oberen Rand */
        #admin .admin-container {
            padding-top: var(--space-xs);
        }

        .admin-header {
            text-align: center;
            margin-bottom: var(--space-sm);
        }

        .admin-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 600;
        }

        .admin-tabs {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space);
            padding: 4px;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow-x: auto;
        }

        .admin-tab {
            padding: var(--space) var(--space-lg);
            border-radius: var(--radius);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            font-family: inherit;
        }

        .admin-tab.active {
            background: var(--primary);
            color: white;
        }

        .admin-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
        }

        /* Mobile Admin Content */
        @media (max-width: 768px) {
            .admin-content {
                padding: var(--space);
                max-height: calc(100vh - 180px);
                border-radius: var(--radius);
                margin: 0 var(--space-xs);
            }
            
            .admin-content h3 {
                font-size: 1.125rem;
                margin-bottom: var(--space);
            }
            
            .admin-content .card {
                padding: var(--space);
                margin-bottom: var(--space);
            }
            
            .admin-content .grid {
                gap: var(--space);
            }
            
            /* Touch-optimized inputs */
            .admin-content .input {
                min-height: 48px;
                font-size: 16px; /* Prevents zoom on iOS */
                padding: var(--space) var(--space-sm);
            }
            
            .admin-content .field {
                margin-bottom: var(--space-lg);
            }
            
            .admin-content .field label {
                font-size: 0.875rem;
                margin-bottom: var(--space-xs);
                display: block;
                font-weight: 600;
            }
            
            /* User management mobile optimization */
            .admin-content #newUserName,
            .admin-content #newUserEmail {
                margin-bottom: var(--space);
                width: 100%;
            }
            
            /* Date filter mobile */
            .admin-content #orderDateFilter {
                min-height: 48px;
                font-size: 16px;
            }
            
            /* Touch-optimized buttons */
            .admin-content .btn {
                min-height: 48px;
                padding: var(--space-sm) var(--space);
                font-size: 0.875rem;
                margin: var(--space-xs) 0;
            }
            
            /* User management buttons */
            .admin-content .user-management .btn {
                margin: var(--space-xs);
                min-width: 120px;
                flex: 1;
            }
            
            /* Order management buttons */
            .admin-content .order-management .btn {
                font-size: 0.75rem;
                padding: var(--space-xs) var(--space-sm);
                margin: 2px;
            }
            
            /* Restaurant management buttons */
            .admin-content .restaurant-management .btn {
                width: 100%;
                margin-bottom: var(--space-xs);
            }
            
            /* Add user section mobile */
            .admin-content .add-user-section {
                flex-direction: column;
                gap: var(--space);
                padding: var(--space);
            }
            
            .admin-content .add-user-section .input {
                margin-bottom: var(--space);
            }
            
            .admin-content .add-user-section .btn {
                width: 100%;
            }
        }

        .pickup-grid {
            display: grid;
            gap: var(--space-lg);
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .pickup-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .pickup-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-lg);
        }

        .pickup-card h4 {
            margin: 0 0 var(--space-lg) 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            padding-bottom: var(--space);
            border-bottom: 1px solid var(--border);
        }

        .pickup-info {
            display: grid;
            gap: var(--space);
        }

        .pickup-info .field {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .pickup-info .field label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .pickup-stats {
            margin-top: var(--space);
            padding-top: var(--space);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }

        .paypal-preview {
            margin-top: var(--space-xs);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space);
            background: var(--background);
        }

        .paypal-preview img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius);
            display: block;
            margin: 0 auto;
        }

        .no-image {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            padding: var(--space-xl);
        }


        .pickup-stats {
            margin-top: var(--space);
            padding-top: var(--space);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .paypal-preview {
            text-align: center;
            margin-top: var(--space);
        }

        .paypal-preview img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .paypal-preview img:hover {
            transform: scale(1.02);
        }

        .no-image {
            padding: var(--space-xl);
            background: rgba(255, 255, 255, 0.02);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .restaurant-grid {
            display: grid;
            gap: var(--space-lg);
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }

        .restaurant-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--space-lg);
        }

        .restaurant-card h4 {
            margin: 0 0 var(--space-xs) 0;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .restaurant-card p {
            margin: 0 0 var(--space) 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .menu-items {
            display: grid;
            gap: var(--space-sm);
            margin-bottom: var(--space);
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm);
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius);
            font-size: 0.875rem;
        }

        .menu-item-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .menu-item-price {
            color: var(--primary);
            font-weight: 600;
        }

        /* Burger Menu */
        /* Header Logo */
        .header-logo {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 200;
            color: var(--text-primary);
            filter: drop-shadow(0 4px 12px rgba(139, 92, 246, 0.4));
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px;
            border-radius: var(--radius-lg);
            background: var(--surface-glass);
            border: 1px solid var(--border-glass);
            backdrop-filter: var(--backdrop-blur);
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo:hover {
            transform: scale(1.1) translateY(-2px);
            filter: drop-shadow(0 8px 25px rgba(139, 92, 246, 0.6));
            background: var(--surface-hover);
        }

        .burger-menu {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 200;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            background: var(--surface-card);
            border: 1px solid var(--border-glass);
            backdrop-filter: var(--backdrop-blur);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .burger-menu:hover {
            background: var(--surface-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .burger-icon {
            width: 20px;
            height: 20px;
            stroke: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* Burger menu lines animation */
        .burger-line {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center;
        }

        .burger-menu.open .burger-line:nth-child(1) {
            transform: rotate(45deg) translate(0px, 6px);
        }

        .burger-menu.open .burger-line:nth-child(2) {
            opacity: 0;
            transform: scaleX(0);
        }

        .burger-menu.open .burger-line:nth-child(3) {
            transform: rotate(-45deg) translate(0px, -6px);
        }

        /* Mobile Menu Overlay */
        .menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .menu-panel {
            position: fixed;
            top: 0;
            right: -380px;
            width: 360px;
            height: 100vh;
            background: var(--surface-card);
            backdrop-filter: var(--backdrop-blur-strong);
            border-left: 1px solid var(--border-glass);
            padding: var(--space-2xl) var(--space-xl);
            z-index: 160;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .menu-panel.open {
            right: 0;
        }

        .menu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space);
            border-bottom: 1px solid var(--border);
        }

        .menu-items {
            display: grid;
            gap: var(--space-sm);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: var(--space);
            padding: var(--space);
            border-radius: var(--radius);
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
            text-align: left;
        }

        .menu-item:hover {
            background: var(--surface-hover);
        }

        .menu-item .menu-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Hero */
        .hero {
            text-align: center;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(6, 182, 212, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, rgba(244, 114, 182, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 30% 80%, rgba(34, 197, 94, 0.2) 0%, transparent 50%);
        }

        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                linear-gradient(135deg, rgba(26, 13, 46, 0.85) 0%, rgba(45, 27, 78, 0.75) 50%, rgba(76, 29, 149, 0.65) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            z-index: 1;
        }

        .hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="g1" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="rgba(139,92,246,0.08)"/><stop offset="100%" stop-color="transparent"/></radialGradient><radialGradient id="g2" cx="50%" cy="50%" r="30%"><stop offset="0%" stop-color="rgba(6,182,212,0.06)"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><circle cx="200" cy="300" r="150" fill="url(%23g1)" opacity="0.8"><animateTransform attributeName="transform" type="translate" values="0,0; 20,-10; 0,0" dur="15s" repeatCount="indefinite"/></circle><circle cx="800" cy="700" r="100" fill="url(%23g2)" opacity="0.6"><animateTransform attributeName="transform" type="translate" values="0,0; -15,15; 0,0" dur="20s" repeatCount="indefinite"/></circle><circle cx="600" cy="200" r="80" fill="url(%23g1)" opacity="0.7"><animateTransform attributeName="transform" type="translate" values="0,0; 10,20; 0,0" dur="18s" repeatCount="indefinite"/></circle><circle cx="300" cy="800" r="120" fill="url(%23g2)" opacity="0.5"><animateTransform attributeName="transform" type="translate" values="0,0; -20,-5; 0,0" dur="22s" repeatCount="indefinite"/></circle></svg>') no-repeat center center,
                radial-gradient(circle at 30% 20%, rgba(139, 92, 246, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 70% 80%, rgba(6, 182, 212, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(244, 114, 182, 0.1) 0%, transparent 60%);
            background-size: cover, 100% 100%, 100% 100%, 100% 100%;
            opacity: 0.6;
            pointer-events: none;
            z-index: 2;
        }

        .hero-logo {
            margin-bottom: var(--space-lg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            position: relative;
        }

        .hero-logo svg {
            color: var(--text-primary);
            filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.3));
            transition: transform 0.3s ease;
        }

        .hero-logo svg:hover {
            transform: scale(1.05);
        }

        .hero-content {
            position: relative;
            z-index: 3;
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-2xl);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 0 20px rgba(139, 92, 246, 0.1);
        }

        .hero h1 {
            font-size: clamp(3.5rem, 8vw, 6rem);
            font-weight: 800;
            margin-bottom: var(--space-xl);
            background: linear-gradient(135deg, #ffffff 0%, #a78bfa 30%, #06b6d4 60%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            filter: drop-shadow(0 0 30px rgba(139, 92, 246, 0.5));
            text-shadow: 0 0 40px rgba(139, 92, 246, 0.3);
            animation: glow-pulse 3s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            0% { 
                filter: drop-shadow(0 0 30px rgba(139, 92, 246, 0.5));
                transform: scale(1);
            }
            100% { 
                filter: drop-shadow(0 0 40px rgba(139, 92, 246, 0.8));
                transform: scale(1.02);
            }
        }

        .hero p {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: var(--space-2xl);
            line-height: 1.7;
            font-weight: 300;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-actions {
            display: flex;
            gap: var(--space-xl);
            justify-content: center;
            flex-wrap: wrap;
            margin-top: var(--space-xl);
        }

        .hero-actions .btn {
            min-width: 200px;
            font-size: 1.25rem;
            font-weight: 700;
            padding: var(--space-lg) var(--space-2xl);
            border-radius: var(--radius-full);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .hero-actions .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .hero-actions .btn:hover::before {
            transform: translateX(100%);
        }

        .hero-actions .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 20px 40px rgba(139, 92, 246, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .hero-actions .btn-secondary:hover {
            box-shadow: 
                0 20px 40px rgba(6, 182, 212, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* Week Grid */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space);
        }

        .day-card {
            display: grid;
            gap: var(--space);
        }

        .day-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space);
        }

        .day-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }


        /* Routes */
        .route {
            display: none;
            animation: fadeIn 0.3s ease;
            padding-top: var(--space);
        }

        .route.active {
            display: block;
        }

        /* Fix für Admin-Seite - kein Padding oben */
        #admin.route {
            padding-top: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Grid */
        .grid {
            display: grid;
            gap: var(--space-lg);
            grid-template-columns: 1fr;
        }

        .grid-auto {
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        /* Responsive Grid */
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .pickup-grid {
                grid-template-columns: 1fr;
            }
            
            .pickup-card {
                padding: var(--space-lg);
            }
            
            /* Tablet Admin Controls */
            .pickup-card .field > div[style*="display: flex"] {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }

            .pickup-card .btn {
                min-width: 150px;
                padding: var(--space-sm) var(--space-lg);
            }
            
            .admin-tabs {
                flex-wrap: wrap;
                justify-content: center;
                gap: var(--space-xs);
            }
            
            .admin-tab {
                flex: 1 1 auto;
                min-width: 120px;
                text-align: center;
            }
            
            .pickup-stats {
                flex-direction: column;
                gap: var(--space-xs);
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .admin-container {
                padding: var(--space-xs);
            }
            
            .admin-content {
                padding: var(--space);
            }
            
            .pickup-card h4 {
                font-size: 1.125rem;
            }
            
            .hero-logo svg {
                width: 120px;
                height: 60px;
            }

            /* Mobile Admin Optimizations */
            .pickup-card {
                padding: var(--space);
                margin-bottom: var(--space);
            }

            .pickup-card .field {
                margin-bottom: var(--space);
            }

            .pickup-card .field label {
                font-size: 0.875rem;
                font-weight: 600;
                margin-bottom: var(--space-xs);
                display: block;
            }

            /* Mobile-friendly toggle buttons */
            .pickup-card .field > div[style*="display: flex"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: var(--space-xs) !important;
            }

            .pickup-card .btn {
                width: 100%;
                text-align: center;
                padding: var(--space-sm) var(--space);
                font-size: 0.875rem;
                min-width: unset !important;
            }

            /* Mobile voting management - using attribute selector for better compatibility */
            .pickup-card .field div:has(span) {
                flex-direction: column !important;
                align-items: flex-start !important;
            }

            .pickup-card .field div:has(button[onclick*="clearVotes"]) {
                flex-direction: column !important;
                align-items: flex-start !important;
            }

            .pickup-card button[onclick*="clearVotes"] {
                width: 100%;
                margin-top: var(--space-xs);
            }

            /* Mobile PayPal preview */
            .paypal-preview img {
                max-width: 100%;
                height: auto;
                border-radius: var(--radius);
            }

            .no-image {
                padding: var(--space);
                font-size: 0.875rem;
                text-align: center;
            }

            /* Mobile pickup stats */
            .pickup-stats {
                flex-direction: column !important;
                gap: var(--space-xs) !important;
                text-align: center;
                padding: var(--space-sm);
                background: var(--surface-hover);
                border-radius: var(--radius);
                margin-top: var(--space);
            }

            /* Mobile admin tabs */
            .admin-tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-xs);
                padding: var(--space-xs);
                margin-bottom: var(--space);
            }
            
            .admin-tab {
                text-align: center;
                padding: var(--space-sm) var(--space-xs);
                font-size: 0.75rem;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: var(--radius);
            }
            
            .admin-tab.active {
                font-weight: 600;
            }
        }

        /* New Homepage Sections */
        .features-section {
            padding: var(--space-3xl) 0;
            margin: var(--space-2xl) 0;
        }

        .section-header {
            text-align: center;
            margin-bottom: var(--space-3xl);
        }

        .section-header h2 {
            font-size: clamp(2.5rem, 4vw, 3.5rem);
            font-weight: 700;
            margin-bottom: var(--space);
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--space-xl);
            margin-top: var(--space-2xl);
        }

        .feature-card {
            background: var(--surface-card);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            backdrop-filter: var(--backdrop-blur);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-glow);
            border-color: var(--border-hover);
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-icon {
            width: 72px;
            height: 72px;
            background: var(--primary-gradient);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-lg);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .feature-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--space);
            color: var(--text-primary);
        }

        .feature-card p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-lg);
        }

        .feature-stats {
            display: flex;
            gap: var(--space);
        }

        .feature-stats .stat {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            padding: var(--space-xs) var(--space);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-accent);
        }


        .cta-section {
            padding: var(--space-3xl) 0;
            margin: var(--space-2xl) 0;
            text-align: center;
            background: var(--surface-card);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-xl);
            backdrop-filter: var(--backdrop-blur);
            position: relative;
            overflow: hidden;
        }

        .cta-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(circle at 30% 30%, rgba(139, 92, 246, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
            opacity: 0.8;
        }

        /* Global Floating Particles Animation */
        .global-particles {
            position: fixed;
            inset: 0;
            overflow: hidden;
            z-index: 5;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float-particle 20s infinite linear;
        }

        /* Small Particles */
        .particle.small {
            width: 3px;
            height: 3px;
            background: rgba(139, 92, 246, 0.8);
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.6);
        }

        /* Medium Particles */
        .particle.medium {
            width: 5px;
            height: 5px;
            background: rgba(6, 182, 212, 0.9);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.7);
        }

        /* Large Particles */
        .particle.large {
            width: 7px;
            height: 7px;
            background: rgba(244, 114, 182, 0.9);
            box-shadow: 0 0 12px rgba(244, 114, 182, 0.8);
        }

        /* Glowing Particles */
        .particle.glow {
            width: 4px;
            height: 4px;
            background: rgba(34, 197, 94, 1);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.8);
        }

        /* Particle Positioning - More particles for better coverage */
        .particle:nth-child(1) { left: 5%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 12%; animation-delay: 1s; }
        .particle:nth-child(3) { left: 18%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 25%; animation-delay: 3s; }
        .particle:nth-child(5) { left: 32%; animation-delay: 4s; }
        .particle:nth-child(6) { left: 38%; animation-delay: 5s; }
        .particle:nth-child(7) { left: 45%; animation-delay: 6s; }
        .particle:nth-child(8) { left: 52%; animation-delay: 7s; }
        .particle:nth-child(9) { left: 58%; animation-delay: 8s; }
        .particle:nth-child(10) { left: 65%; animation-delay: 9s; }
        .particle:nth-child(11) { left: 72%; animation-delay: 10s; }
        .particle:nth-child(12) { left: 78%; animation-delay: 11s; }
        .particle:nth-child(13) { left: 85%; animation-delay: 12s; }
        .particle:nth-child(14) { left: 92%; animation-delay: 13s; }
        .particle:nth-child(15) { left: 8%; animation-delay: 14s; }
        .particle:nth-child(16) { left: 15%; animation-delay: 15s; }
        .particle:nth-child(17) { left: 22%; animation-delay: 16s; }
        .particle:nth-child(18) { left: 28%; animation-delay: 17s; }
        .particle:nth-child(19) { left: 35%; animation-delay: 18s; }
        .particle:nth-child(20) { left: 42%; animation-delay: 19s; }
        .particle:nth-child(21) { left: 48%; animation-delay: 20s; }
        .particle:nth-child(22) { left: 55%; animation-delay: 21s; }
        .particle:nth-child(23) { left: 62%; animation-delay: 22s; }
        .particle:nth-child(24) { left: 68%; animation-delay: 23s; }
        .particle:nth-child(25) { left: 75%; animation-delay: 24s; }
        .particle:nth-child(26) { left: 82%; animation-delay: 25s; }
        .particle:nth-child(27) { left: 88%; animation-delay: 26s; }
        .particle:nth-child(28) { left: 95%; animation-delay: 27s; }

        /* Different animation speeds for variety */
        .particle:nth-child(even) { animation-duration: 25s; }
        .particle:nth-child(3n) { animation-duration: 18s; }
        .particle:nth-child(5n) { animation-duration: 22s; }

        @keyframes float-particle {
            0% {
                transform: translateY(100vh) translateX(0) scale(0) rotate(0deg);
                opacity: 0;
            }
            5% {
                opacity: 1;
                transform: translateY(95vh) translateX(10px) scale(1) rotate(45deg);
            }
            25% {
                transform: translateY(75vh) translateX(-20px) scale(1.2) rotate(135deg);
            }
            50% {
                transform: translateY(50vh) translateX(15px) scale(0.8) rotate(225deg);
            }
            75% {
                transform: translateY(25vh) translateX(-10px) scale(1.1) rotate(315deg);
            }
            95% {
                opacity: 1;
                transform: translateY(5vh) translateX(5px) scale(1) rotate(405deg);
            }
            100% {
                transform: translateY(0vh) translateX(0) scale(0) rotate(450deg);
                opacity: 0;
            }
        }

        .cta-content {
            position: relative;
            z-index: 1;
            max-width: 700px;
            margin: 0 auto;
        }

        .cta-content h2 {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 700;
            margin-bottom: var(--space-lg);
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .cta-content p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-2xl);
            line-height: 1.6;
        }

        .cta-actions {
            display: flex;
            gap: var(--space-lg);
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-lg {
            padding: var(--space-lg) var(--space-2xl);
            font-size: 1.125rem;
            font-weight: 600;
            min-width: 200px;
        }

        /* Mobile Responsive for New Sections */
        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
            }
            
            .feature-card {
                padding: var(--space-lg);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space);
            }
            
            .cta-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .features-section,
            .cta-section {
                margin: var(--space) var(--space-sm);
                padding: var(--space-xl) var(--space);
            }
            
        }

        /* Utilities */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .mb-4 { margin-bottom: var(--space); }
        .mt-4 { margin-top: var(--space); }

        /* Responsive */
        @media (max-width: 768px) {
            .main {
                padding: var(--space) 12px calc(var(--space) * 4);
            }
            
            .hero {
                min-height: 70vh;
                padding: var(--space-lg) var(--space);
            }
            
            .hero-logo svg {
                width: 150px;
                height: 75px;
            }
            
            .hero-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .day-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
        }

        /* Custom Scrollbar Design mit Glasmorphismus-Effekt */
        /* Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                inset 0 0 20px rgba(139, 92, 246, 0.08),
                0 8px 32px rgba(0, 0, 0, 0.12);
            position: relative;
            margin: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.8), 
                rgba(168, 85, 247, 0.9));
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 0 20px rgba(139, 92, 246, 0.5),
                inset 0 2px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.1),
                0 8px 24px rgba(139, 92, 246, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                rgba(168, 85, 247, 0.9), 
                rgba(139, 92, 246, 0.95));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 
                0 0 30px rgba(139, 92, 246, 0.8),
                inset 0 2px 0 rgba(255, 255, 255, 0.5),
                inset 0 -2px 0 rgba(0, 0, 0, 0.15),
                0 12px 36px rgba(139, 92, 246, 0.4);
            transform: scale(1.08);
        }

        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.95), 
                rgba(168, 85, 247, 1));
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            box-shadow: 
                0 0 40px rgba(139, 92, 246, 1),
                inset 0 3px 0 rgba(255, 255, 255, 0.6),
                inset 0 -3px 0 rgba(0, 0, 0, 0.2),
                0 16px 48px rgba(139, 92, 246, 0.6);
            transform: scale(1.02);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--surface-glass);
        }

        /* Partikeleffekt für Scrollbar */
        @keyframes scrollParticle {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0);
            }
            50% {
                opacity: 1;
                transform: translateY(-10px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-20px) scale(0);
            }
        }

        /* Custom scrollbar for specific containers mit Glasmorphismus */
        .menu-grid::-webkit-scrollbar,
        .admin-content::-webkit-scrollbar,
        .pickup-grid::-webkit-scrollbar,
        .restaurant-grid::-webkit-scrollbar,
        .order-list::-webkit-scrollbar {
            width: 12px;
        }

        .menu-grid::-webkit-scrollbar-track,
        .admin-content::-webkit-scrollbar-track,
        .pickup-grid::-webkit-scrollbar-track,
        .restaurant-grid::-webkit-scrollbar-track,
        .order-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 
                inset 0 0 15px rgba(139, 92, 246, 0.06),
                0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 1px;
        }

        .menu-grid::-webkit-scrollbar-thumb,
        .admin-content::-webkit-scrollbar-thumb,
        .pickup-grid::-webkit-scrollbar-thumb,
        .restaurant-grid::-webkit-scrollbar-thumb,
        .order-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.7), 
                rgba(168, 85, 247, 0.8));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 0 15px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.35),
                inset 0 -1px 0 rgba(0, 0, 0, 0.08),
                0 6px 18px rgba(139, 92, 246, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .menu-grid::-webkit-scrollbar-thumb:hover,
        .admin-content::-webkit-scrollbar-thumb:hover,
        .pickup-grid::-webkit-scrollbar-thumb:hover,
        .restaurant-grid::-webkit-scrollbar-thumb:hover,
        .order-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, 
                rgba(168, 85, 247, 0.8), 
                rgba(139, 92, 246, 0.9));
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow: 
                0 0 25px rgba(139, 92, 246, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.12),
                0 8px 24px rgba(139, 92, 246, 0.4);
            transform: scale(1.05);
        }

        /* Scrollbar Glow Effekt mit Glasmorphismus */
        ::-webkit-scrollbar-thumb::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: scrollbarGlow 3s infinite ease-in-out;
        }

        @keyframes scrollbarGlow {
            0% { 
                transform: translateX(-150%);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% { 
                transform: translateX(150%);
                opacity: 0;
            }
        }

        /* Zusätzlicher Glasmorphismus-Effekt für die Scrollbar */
        ::-webkit-scrollbar-thumb::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15), 
                rgba(255, 255, 255, 0.05));
            border-radius: 18px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Dark mode scrollbar adjustments mit Glasmorphismus */
        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar-track {
                background: rgba(10, 10, 10, 0.6);
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 
                    inset 0 0 25px rgba(139, 92, 246, 0.05),
                    0 8px 32px rgba(0, 0, 0, 0.3);
            }
            
            ::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, 
                    rgba(139, 92, 246, 0.9), 
                    rgba(168, 85, 247, 0.95));
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.25);
                box-shadow: 
                    0 0 25px rgba(139, 92, 246, 0.6),
                    inset 0 2px 0 rgba(255, 255, 255, 0.3),
                    inset 0 -2px 0 rgba(0, 0, 0, 0.2),
                    0 10px 30px rgba(139, 92, 246, 0.4);
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, 
                    rgba(168, 85, 247, 0.95), 
                    rgba(139, 92, 246, 1));
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                box-shadow: 
                    0 0 35px rgba(139, 92, 246, 0.9),
                    inset 0 2px 0 rgba(255, 255, 255, 0.4),
                    inset 0 -2px 0 rgba(0, 0, 0, 0.25),
                    0 12px 40px rgba(139, 92, 246, 0.6);
            }
            
            * {
                scrollbar-color: rgba(139, 92, 246, 0.8) rgba(10, 10, 10, 0.6);
            }
        }
    </style>
</head>

<body>
    <!-- Global Floating Particles Background -->
    <div class="global-particles">
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
        <div class="particle small"></div>
        <div class="particle medium"></div>
        <div class="particle large"></div>
        <div class="particle glow"></div>
    </div>
    
    <div class="app">
        <main class="main">
            <!-- Home -->
            <section id="home" class="route active">
                <div class="hero">
                    
                    <div class="hero-content">
                    <div class="hero-logo">
                        <svg width="250" height="125" viewBox="0 0 400 200" fill="currentColor">
                            <!-- Animated Network Nodes -->
                            <circle cx="70" cy="50" r="8" fill="currentColor">
                                <animate attributeName="r" values="8;12;8" dur="3s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="20" cy="100" r="8" fill="currentColor">
                                <animate attributeName="r" values="8;12;8" dur="3s" begin="0.5s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="120" cy="100" r="8" fill="currentColor">
                                <animate attributeName="r" values="8;12;8" dur="3s" begin="1s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="70" cy="150" r="8" fill="currentColor">
                                <animate attributeName="r" values="8;12;8" dur="3s" begin="1.5s" repeatCount="indefinite"/>
                            </circle>
                            
                            <!-- Animated Network Lines -->
                            <line x1="70" y1="58" x2="70" y2="92" stroke="currentColor" stroke-width="3">
                                <animate attributeName="stroke-width" values="3;5;3" dur="3s" repeatCount="indefinite"/>
                            </line>
                            <line x1="28" y1="100" x2="62" y2="100" stroke="currentColor" stroke-width="3">
                                <animate attributeName="stroke-width" values="3;5;3" dur="3s" begin="0.7s" repeatCount="indefinite"/>
                            </line>
                            <line x1="78" y1="100" x2="112" y2="100" stroke="currentColor" stroke-width="3">
                                <animate attributeName="stroke-width" values="3;5;3" dur="3s" begin="1.4s" repeatCount="indefinite"/>
                            </line>
                            <line x1="70" y1="108" x2="70" y2="142" stroke="currentColor" stroke-width="3">
                                <animate attributeName="stroke-width" values="3;5;3" dur="3s" begin="2.1s" repeatCount="indefinite"/>
                            </line>
                            
                            <!-- Main Circle with Glow -->
                            <circle cx="70" cy="100" r="35" fill="none" stroke="currentColor" stroke-width="4">
                                <animate attributeName="stroke-width" values="4;6;4" dur="4s" repeatCount="indefinite"/>
                            </circle>
                            
                            <!-- Animated Fork -->
                            <g transform="translate(55, 75)">
                                <line x1="0" y1="0" x2="0" y2="50" stroke="currentColor" stroke-width="3"/>
                                <line x1="-6" y1="0" x2="-6" y2="15" stroke="currentColor" stroke-width="2">
                                    <animateTransform attributeName="transform" type="rotate" values="0;5;0" dur="2s" repeatCount="indefinite"/>
                                </line>
                                <line x1="-3" y1="0" x2="-3" y2="20" stroke="currentColor" stroke-width="2">
                                    <animateTransform attributeName="transform" type="rotate" values="0;3;0" dur="2s" begin="0.2s" repeatCount="indefinite"/>
                                </line>
                                <line x1="3" y1="0" x2="3" y2="20" stroke="currentColor" stroke-width="2">
                                    <animateTransform attributeName="transform" type="rotate" values="0;-3;0" dur="2s" begin="0.4s" repeatCount="indefinite"/>
                                </line>
                                <line x1="6" y1="0" x2="6" y2="15" stroke="currentColor" stroke-width="2">
                                    <animateTransform attributeName="transform" type="rotate" values="0;-5;0" dur="2s" begin="0.6s" repeatCount="indefinite"/>
                                </line>
                            </g>
                            
                            <!-- Animated Knife -->
                            <g transform="translate(85, 75)">
                                <line x1="0" y1="0" x2="0" y2="50" stroke="currentColor" stroke-width="3">
                                    <animateTransform attributeName="transform" type="rotate" values="0;2;0" dur="2.5s" repeatCount="indefinite"/>
                                </line>
                                <path d="M-3,0 L3,0 L2,15 L-2,15 Z" fill="currentColor">
                                    <animateTransform attributeName="transform" type="rotate" values="0;2;0" dur="2.5s" repeatCount="indefinite"/>
                                </path>
                            </g>
                            
                            <!-- Animated GetEAT Text -->
                            <g transform="translate(170, 60)">
                                <text x="0" y="40" font-family="'DM Serif Display', serif" font-size="48" font-weight="bold" fill="currentColor">
                                    Get
                                    <animate attributeName="opacity" values="1;0.7;1" dur="4s" repeatCount="indefinite"/>
                                </text>
                                <text x="0" y="90" font-family="'DM Serif Display', serif" font-size="48" font-weight="bold" fill="currentColor">
                                    EAT
                                    <animate attributeName="opacity" values="1;0.7;1" dur="4s" begin="2s" repeatCount="indefinite"/>
                                </text>
                            </g>
                        </svg>
                    </div>
                        <h1>GetEat</h1>
                        <p>Professionelles Team-Lunch-Management mit Voting, Bestellungen und intelligenter Koordination für dein Unternehmen.</p>
                        <div class="hero-actions">
                            <button class="btn btn-primary" data-route="voting">Jetzt abstimmen</button>
                            <button class="btn btn-secondary" data-route="login">Anmelden</button>
                        </div>
                    </div>
                </div>

                <!-- Features Section -->
                <div class="features-section">
                    <div class="container">
                        <div class="section-header">
                            <h2>Warum GetEat?</h2>
                            <p>Die moderne Lösung für Team-Lunch-Management</p>
                        </div>
                        
                        <div class="features-grid">
                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                </div>
                                <h3>Demokratisches Voting</h3>
                                <p>Stimme für dein Lieblings-Restaurant ab und lass die Mehrheit entscheiden. Faire und transparente Abstimmungen für alle.</p>
                                <div class="feature-stats">
                                    <span class="stat">100% Fair</span>
                                    <span class="stat">Live Updates</span>
                                </div>
                            </div>

                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/>
                                    </svg>
                                </div>
                                <h3>Wochenplanung</h3>
                                <p>Plane deine gesamte Lunch-Woche im Voraus. Übersichtliche Kalenderansicht mit allen wichtigen Informationen.</p>
                                <div class="feature-stats">
                                    <span class="stat">5 Tage</span>
                                    <span class="stat">Auto-Sync</span>
                                </div>
                            </div>

                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M7 4V2C7 1.45 7.45 1 8 1S9 1.55 9 2V4H15V2C15 1.45 15.45 1 16 1S17 1.55 17 2V4C18.1 4 19 4.9 19 6V8H5V6C5 4.9 5.9 4 7 4M19 19V10H5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19M7 12H17V14H7V12M7 16H14V18H7V16Z"/>
                                    </svg>
                                </div>
                                <h3>Smart Bestellungen</h3>
                                <p>Bestelle direkt aus der App mit integrierter PayPal-Zahlung. Automatische Kostenaufteilung und Abrechnung.</p>
                                <div class="feature-stats">
                                    <span class="stat">PayPal</span>
                                    <span class="stat">Auto-Split</span>
                                </div>
                            </div>

                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A2.996 2.996 0 0 0 17.06 7H16.5c-.83 0-1.5.67-1.5 1.5v.5h-2v-.5c0-.83-.67-1.5-1.5-1.5h-.56c-1.31 0-2.44.83-2.9 2.06L5.5 16H8v6h4v-6h2V10h2v10h4z"/>
                                    </svg>
                                </div>
                                <h3>Team-Koordination</h3>
                                <p>Verwalte Teilnehmer, Abholer und Koordination zentral. Alle wichtigen Infos an einem Ort für das ganze Team.</p>
                                <div class="feature-stats">
                                    <span class="stat">Multi-User</span>
                                    <span class="stat">Admin Panel</span>
                                </div>
                            </div>

                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <h3>PWA-Ready</h3>
                                <p>Installiere GetEat auf deinem Smartphone für den schnellen Zugriff. Funktioniert wie eine native App.</p>
                                <div class="feature-stats">
                                    <span class="stat">Offline</span>
                                    <span class="stat">Push Notifications</span>
                                </div>
                            </div>

                            <div class="feature-card">
                                <div class="feature-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H19V1h-2v1H7V1H5v1H4.5C3.11 2 2 3.11 2 4.5v15C2 20.89 3.11 22 4.5 22h15c1.39 0 2.5-1.11 2.5-2.5v-15C22 3.11 20.89 2 19.5 2zM20 19.5c0 .28-.22.5-.5.5h-15c-.28 0-.5-.22-.5-.5v-12h16v12z"/>
                                    </svg>
                                </div>
                                <h3>Analytics & Reports</h3>
                                <p>Detaillierte Statistiken über Bestellungen, Kosten und Präferenzen. CSV-Export für die Buchhaltung.</p>
                                <div class="feature-stats">
                                    <span class="stat">CSV Export</span>
                                    <span class="stat">Live Stats</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- CTA Section -->
                <div class="cta-section">
                    <div class="container">
                        <div class="cta-content">
                            <h2>Bereit für bessere Team-Lunches?</h2>
                            <p>Starte jetzt mit GetEat und erlebe, wie einfach Team-Lunch-Management sein kann.</p>
                            <div class="cta-actions">
                                <button class="btn btn-primary btn-lg" data-route="register">Registrieren</button>
                                <button class="btn btn-secondary btn-lg" data-route="voting">Jetzt abzustimmen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Login -->
            <section id="login" class="route">
                <div class="container" style="display: grid; align-content: center; min-height: 80vh;">
                    <div class="auth-form">
                        <h2>Anmelden</h2>
                        <form id="loginForm">
                            <div class="form-grid">
                                <div class="field">
                                    <label>E-Mail oder Benutzername</label>
                                    <input type="text" class="input" id="loginEmail" placeholder="admin oder max@firma.de" required>
                                </div>
                                <div class="field">
                                    <label>Passwort</label>
                                    <input type="password" class="input" id="loginPassword" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Anmelden</button>
                            </div>
                            <div class="form-links">
                                <a href="#" data-route="register">Noch kein Konto? Registrieren</a>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Register -->
            <section id="register" class="route">
                <div class="container" style="display: grid; align-content: center; min-height: 80vh;">
                    <div class="auth-form">
                        <h2>Registrieren</h2>
                        <form id="registerForm">
                            <div class="form-grid">
                                <div class="field">
                                    <label>Name</label>
                                    <input type="text" class="input" id="regName" placeholder="Max Mustermann" required>
                                </div>
                                <div class="field">
                                    <label>E-Mail</label>
                                    <input type="email" class="input" id="regEmail" placeholder="max@firma.de" required>
                                </div>
                                <div class="field">
                                    <label>Passwort</label>
                                    <input type="password" class="input" id="regPassword" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Registrieren</button>
                            </div>
                            <div class="form-links">
                                <a href="#" data-route="login">Bereits registriert? Anmelden</a>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Voting -->
            <section id="voting" class="route">
                <div class="container">
                    <h2 class="text-center mb-4">Wochenplanung & Voting</h2>
                    <div class="week-grid" id="weekGrid">
                        <!-- Generated by JavaScript -->
                    </div>

                    <!-- Order Section -->
                    <div class="card mt-4" id="orderSection" style="display: none;">
                        <h3 class="mb-4">Bestellung für <span id="orderDay"></span></h3>
                        <div id="menuGrid" class="grid">
                            <!-- Generated by JavaScript -->
                        </div>
                        <div class="mt-4" id="cartSummary">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile -->
            <section id="profile" class="route">
                <div class="container">
                    <div class="profile-header">
                        <div class="profile-card">
                            <div class="profile-avatar">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <div class="profile-info">
                                <h3 id="userName">Nicht angemeldet</h3>
                                <p id="userEmail"></p>
                                <p id="userRole"></p>
                            </div>
                            <div class="profile-actions">
                                <button class="btn btn-primary" id="showOrderHistory">Bestellhistorie anzeigen</button>
                                <button class="btn btn-secondary" id="changePassword">Passwort ändern</button>
                                <button class="btn btn-secondary" id="enableNotifications">Aktivieren</button>
                                <button class="btn btn-ghost" id="logoutBtn" style="display: none;">Abmelden</button>
                            </div>
                        </div>
                    </div>
                        
                        <!-- Order History -->
                        <div id="orderHistorySection" style="display: none; margin-top: var(--space-lg);">
                            <h3 class="mb-4">📦 Meine Bestellhistorie</h3>
                            <div id="orderHistoryList" class="grid">
                                <!-- Generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Menu -->
            <section id="menu" class="route">
                <div class="container">
                    <div class="card">
                        <h2 class="mb-4">Menü</h2>
                        <div class="grid">
                            <button class="btn btn-ghost" data-route="home">🏠 Startseite</button>
                            <button class="btn btn-ghost" data-route="voting">🗳️ Voting</button>
                            <button class="btn btn-ghost" data-route="profile">👤 Profil</button>
                            <button class="btn btn-ghost" data-route="admin" id="adminMenuBtn" style="display: none;">🛠️ Admin</button>
                            <button class="btn btn-ghost" data-route="login">🔐 Anmelden</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin -->
            <section id="admin" class="route">
                <div class="admin-container">
                    <div class="admin-header">
                        <h2>Admin Dashboard</h2>
                    </div>
                    
                    <!-- Admin Tabs -->
                    <div class="admin-tabs">
                        <button class="admin-tab active" data-tab="overview">Übersicht</button>
                        <button class="admin-tab" data-tab="pickup">Abholung</button>
                        <button class="admin-tab" data-tab="restaurants">Restaurants</button>
                        <button class="admin-tab" data-tab="users">Benutzer</button>
                        <button class="admin-tab" data-tab="orders">Bestellungen</button>
                        <button class="admin-tab" data-tab="settings">Einstellungen</button>
                    </div>

                    <!-- Overview Tab -->
                    <div id="admin-overview" class="admin-content">
                        <div class="grid grid-auto">
                            <div class="card">
                                <h3 class="mb-4">📊 Gesamtstatistiken</h3>
                                <div id="adminStats" class="text-muted">
                                    Lade Statistiken...
                                </div>
                            </div>
                            <div class="card">
                                <h3 class="mb-4">📅 Tagesstatistiken</h3>
                                <div id="dailyStats" class="text-muted">
                                    Lade Tagesstatistiken...
                                </div>
                            </div>
                            <div class="card">
                                <h3 class="mb-4">📄 Export</h3>
                                <div class="grid">
                                    <button class="btn btn-primary" id="exportOrders">Bestellungen CSV</button>
                                    <button class="btn btn-secondary" id="exportVotes">Voting CSV</button>
                                </div>
                            </div>
                            <div class="card">
                                <h3 class="mb-4">🔔 Benachrichtigungen</h3>
                                <button class="btn btn-secondary" id="sendPush">Erinnerung senden</button>
                            </div>
                        </div>
                    </div>

                    <!-- Pickup Management Tab -->
                    <div id="admin-pickup" class="admin-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                            <h3 style="margin: 0; color: var(--text-primary);">🚗 Abholung & PayPal Management</h3>
                            <div style="display: flex; gap: var(--space-xs);">
                                <button class="btn btn-primary" onclick="toggleAllOrdering(true)">🔓 Alle freischalten</button>
                                <button class="btn btn-secondary" onclick="toggleAllOrdering(false)">🔒 Alle sperren</button>
                            </div>
                        </div>
                        <div id="pickupManagement" class="pickup-grid">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>

                    <!-- Restaurant Management Tab -->
                    <div id="admin-restaurants" class="admin-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                            <h3 style="margin: 0; color: var(--text-primary);">🏪 Restaurant Management</h3>
                            <button class="btn btn-primary" onclick="addNewRestaurant()">Neues Restaurant hinzufügen</button>
                        </div>
                        <div id="restaurantManagement" class="restaurant-grid">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>

                    <!-- User Management Tab -->
                    <div id="admin-users" class="admin-content" style="display: none;">
                        <div class="card">
                            <h3 class="mb-4">👥 Benutzer Management</h3>
                            
                            <!-- Add User Section -->
                            <div class="add-user-section" style="display: flex; gap: var(--space); align-items: center; margin-bottom: var(--space-lg); padding: var(--space); background: var(--background); border-radius: var(--radius); border: 1px solid var(--border);">
                                <input type="text" id="newUserName" class="input" placeholder="Benutzername" style="flex: 1;">
                                <input type="email" id="newUserEmail" class="input" placeholder="E-Mail Adresse" style="flex: 1;">
                                <button class="btn btn-primary" onclick="addNewUser()">Benutzer anlegen</button>
                            </div>
                            
                            <div id="userManagement" class="grid">
                                <!-- Generated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Order Management Tab -->
                    <div id="admin-orders" class="admin-content" style="display: none;">
                        <div class="card">
                            <h3 class="mb-4">📦 Bestellungen Management</h3>
                            
                            <!-- Date Filter -->
                            <div style="display: flex; gap: var(--space); align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap;">
                                <label style="font-weight: 600; color: var(--text-primary);">Nach Datum filtern:</label>
                                <input type="date" id="orderDateFilter" class="input" style="width: auto;">
                                <button class="btn btn-secondary" onclick="clearOrderDateFilter()">Alle anzeigen</button>
                                <div style="margin-left: auto; color: var(--text-muted); font-size: 0.875rem;" id="orderCount">
                                    <!-- Order count will be displayed here -->
                                </div>
                            </div>
                            
                            <div id="orderManagement">
                                <!-- Generated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="admin-settings" class="admin-content" style="display: none;">
                        <div class="card">
                            <h3 class="mb-4">⚙️ System Einstellungen</h3>
                            
                            <div class="field" style="margin-bottom: var(--space-lg); padding: var(--space); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
                                <label style="display: flex; align-items: center; gap: var(--space-xs); font-weight: 600; color: var(--primary);">
                                    📄 JSON-Datei Management
                                </label>
                                <div id="storage-info"></div>
                                <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="saveState()" style="display: flex; align-items: center; gap: var(--space-xs);">
                                        📥 data.json herunterladen
                                    </button>
                                    <button class="btn btn-secondary" onclick="loadState()" style="display: flex; align-items: center; gap: var(--space-xs);">
                                        🔄 Daten neu laden
                                    </button>
                                </div>
                                <script>
                                    // Update storage info based on environment
                                    document.addEventListener('DOMContentLoaded', () => {
                                        const isLocal = window.location.protocol === 'file:';
                                        const info = document.getElementById('storage-info');
                                        
                                        if (isLocal) {
                                            info.innerHTML = `
                                                <p style="color: var(--text-muted); font-size: 0.875rem; margin: var(--space-xs) 0;">
                                                    🏠 <strong>Lokaler Modus:</strong> Daten werden im Browser-Speicher gespeichert.
                                                </p>
                                                <p style="color: var(--accent); font-size: 0.75rem; margin-bottom: var(--space-xs);">
                                                    💡 <strong>Tipp:</strong> Starten Sie den Server (server.js) für automatisches Speichern in data.json.
                                                </p>
                                            `;
                                        } else {
                                            info.innerHTML = `
                                                <p style="color: var(--text-muted); font-size: 0.875rem; margin: var(--space-xs) 0;">
                                                    🌐 <strong>Server-Modus:</strong> Änderungen werden automatisch in data.json gespeichert!
                                                </p>
                                                <p style="color: var(--primary); font-size: 0.75rem; margin-bottom: var(--space-xs);">
                                                    ✅ Jede Aktion wird sofort in der Datei gespeichert - kein Download nötig.
                                                </p>
                                            `;
                                        }
                                    });
                                </script>
                            </div>
                            
                            <div class="grid">
                                <div class="field">
                                    <label>👥 Admin-Benutzer verwalten</label>
                                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--space-sm);">
                                        Erstellen Sie Benutzer im User-Management und setzen Sie deren Rolle auf "admin" für Admin-Zugang.
                                    </p>
                                    <button class="btn btn-secondary" onclick="showRoute('admin'); document.querySelector('[data-tab=users]').click();">
                                        Zu User-Management
                                    </button>
                                </div>
                                <div class="field">
                                    <label>Erlaubte Admin Benutzer (kommagetrennt)</label>
                                    <input type="text" class="input" id="adminUsersInput" placeholder="administrator,admin,chef">
                                    <button class="btn btn-secondary" id="updateAdminUsers">Admin Liste aktualisieren</button>
                                </div>
                                <div class="field">
                                    <label>Datenbank</label>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="btn btn-ghost" id="exportDatabase">Datenbank exportieren</button>
                                        <button class="btn btn-danger" id="clearDatabase">Datenbank löschen</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Header Logo -->
        <div class="header-logo" id="headerLogo">
            <svg width="32" height="32" viewBox="0 0 100 100" fill="currentColor">
                <!-- Simplified Logo - Network Pattern -->
                <circle cx="25" cy="25" r="5" fill="currentColor"/>
                <circle cx="75" cy="25" r="5" fill="currentColor"/>
                <circle cx="25" cy="75" r="5" fill="currentColor"/>
                <circle cx="75" cy="75" r="5" fill="currentColor"/>
                <circle cx="50" cy="50" r="7" fill="currentColor"/>
                
                <!-- Network Lines -->
                <line x1="30" y1="30" x2="45" y2="45" stroke="currentColor" stroke-width="2"/>
                <line x1="70" y1="30" x2="55" y2="45" stroke="currentColor" stroke-width="2"/>
                <line x1="30" y1="70" x2="45" y2="55" stroke="currentColor" stroke-width="2"/>
                <line x1="70" y1="70" x2="55" y2="55" stroke="currentColor" stroke-width="2"/>
                
                <!-- Center Ring -->
                <circle cx="50" cy="50" r="15" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </div>

        <!-- Burger Menu -->
        <div class="burger-menu" id="burgerMenu">
            <svg class="burger-icon" viewBox="0 0 24 24">
                <line class="burger-line" x1="3" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line class="burger-line" x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line class="burger-line" x1="3" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>

        <!-- Menu Overlay -->
        <div class="menu-overlay" id="menuOverlay"></div>

        <!-- Menu Panel -->
        <div class="menu-panel" id="menuPanel">
            <div class="menu-header">
                <h3>Navigation</h3>
            </div>
            <div class="menu-items">
                <button class="menu-item" data-route="home">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M12 3l9 7v11h-6v-6h-6v6H3V10z"/>
                    </svg>
                    Startseite
                </button>
                <button class="menu-item" data-route="voting">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Voting & Bestellung
                </button>
                <button class="menu-item" data-route="profile">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Profil & Historie
                </button>
                <button class="menu-item" data-route="admin" id="adminMenuItem" style="display: none;">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5z"/>
                    </svg>
                    Admin Dashboard
                </button>
                <button class="menu-item" data-route="login" id="loginMenuItem">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5z"/>
                    </svg>
                    Anmelden
                </button>
                <button class="menu-item" data-route="register" id="registerMenuItem">
                    <svg class="menu-icon" viewBox="0 0 24 24">
                        <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Registrieren
                </button>
            </div>
        </div>
    </div>

    <script>
        // App State Management
        const state = {
            currentUser: null,
            currentRoute: 'home',
            adminSettings: {
                paypalCodes: {}, // { dayIndex: 'paypal-code' }
                pickupPersons: {}, // { dayIndex: 'Person Name' }
                orderingEnabled: { 0: true, 1: true, 2: true, 3: true, 4: true }, // { dayIndex: true/false }
                allowedAdmins: ['administrator', 'admin', 'chef'],
                dailyRestaurants: {}, // { dayIndex: [restaurantIds] }
                savedPersons: {}, // { personName: 'paypal-image-data' }
                personsList: [] // Array of saved person names
            },
            restaurants: [
                {
                    id: 'r1',
                    name: 'Baku',
                    category: 'Orientalisch',
                    menu: [
                        { id: 'm1', name: 'Döner Kebab', price: 6.50 },
                        { id: 'm2', name: 'Lahmacun', price: 5.90 },
                        { id: 'm3', name: 'Adana Kebab', price: 12.50 },
                        { id: 'm4', name: 'Falafel Teller', price: 8.90 },
                        { id: 'm5', name: 'Baklava', price: 3.50 }
                    ]
                },
                {
                    id: 'r2',
                    name: 'Little Asia Kulmbach',
                    category: 'Asiatisch',
                    menu: [
                        { id: 'm6', name: 'Gebratene Nudeln mit Hühnchen', price: 9.80 },
                        { id: 'm7', name: 'Sweet & Sour Schweinefleisch', price: 11.50 },
                        { id: 'm8', name: 'Vegetarische Frühlingsrollen', price: 4.90 },
                        { id: 'm9', name: 'Tom Kha Gai Suppe', price: 6.50 },
                        { id: 'm10', name: 'Pad Thai', price: 10.90 }
                    ]
                },
                {
                    id: 'r3',
                    name: 'Döner Haus Berlin',
                    category: 'Türkisch',
                    menu: [
                        { id: 'm11', name: 'Döner im Brot', price: 5.50 },
                        { id: 'm12', name: 'Döner Teller', price: 9.90 },
                        { id: 'm13', name: 'Iskender Kebab', price: 13.50 },
                        { id: 'm14', name: 'Türkische Pizza', price: 7.80 },
                        { id: 'm15', name: 'Ayran', price: 2.50 }
                    ]
                },
                {
                    id: 'r4',
                    name: 'Asia Nguyen',
                    category: 'Vietnamesisch',
                    menu: [
                        { id: 'm16', name: 'Pho Bo (Rindfleischsuppe)', price: 8.90 },
                        { id: 'm17', name: 'Bun Bo Nam Bo', price: 10.50 },
                        { id: 'm18', name: 'Frühlingsrollen (2 Stück)', price: 4.50 },
                        { id: 'm19', name: 'Com Ga (Hühnchenreis)', price: 9.80 },
                        { id: 'm20', name: 'Che Ba Mau (Dessert)', price: 4.20 }
                    ]
                },
                {
                    id: 'r5',
                    name: 'Filion',
                    category: 'Griechisch',
                    menu: [
                        { id: 'm21', name: 'Gyros Teller', price: 12.80 },
                        { id: 'm22', name: 'Souvlaki Spieße', price: 11.50 },
                        { id: 'm23', name: 'Griechischer Salat', price: 7.90 },
                        { id: 'm24', name: 'Moussaka', price: 13.90 },
                        { id: 'm25', name: 'Tzatziki mit Pita', price: 4.80 }
                    ]
                },
                {
                    id: 'r6',
                    name: 'Business Lunch',
                    category: 'Business',
                    menu: [
                        { id: 'm26', name: 'Executive Salat', price: 9.50 },
                        { id: 'm27', name: 'Gegrilltes Lachsfilet', price: 16.90 },
                        { id: 'm28', name: 'Rindermedaillons', price: 18.50 },
                        { id: 'm29', name: 'Quinoa Bowl', price: 11.90 },
                        { id: 'm30', name: 'Tiramisu', price: 5.90 }
                    ]
                },
                {
                    id: 'r7',
                    name: 'Monti´s',
                    category: 'Italienisch',
                    menu: [
                        { id: 'm31', name: 'Pizza Margherita', price: 8.50 },
                        { id: 'm32', name: 'Spaghetti Carbonara', price: 10.90 },
                        { id: 'm33', name: 'Lasagne della Casa', price: 12.50 },
                        { id: 'm34', name: 'Antipasti Misti', price: 9.80 },
                        { id: 'm35', name: 'Panna Cotta', price: 4.90 }
                    ]
                },
                {
                    id: 'r8',
                    name: 'Alivante',
                    category: 'Spanisch',
                    menu: [
                        { id: 'm36', name: 'Paella Valenciana', price: 14.90 },
                        { id: 'm37', name: 'Tapas Variadas', price: 12.50 },
                        { id: 'm38', name: 'Gazpacho', price: 5.90 },
                        { id: 'm39', name: 'Jamón Ibérico', price: 16.50 },
                        { id: 'm40', name: 'Crema Catalana', price: 4.80 }
                    ]
                },
                {
                    id: 'r9',
                    name: 'FrankenFarm',
                    category: 'Regional',
                    menu: [
                        { id: 'm41', name: 'Schäuferla mit Kloß', price: 13.80 },
                        { id: 'm42', name: 'Bratwurst mit Sauerkraut', price: 8.90 },
                        { id: 'm43', name: 'Sauerbraten', price: 14.50 },
                        { id: 'm44', name: 'Fränkischer Salat', price: 7.50 },
                        { id: 'm45', name: 'Apfelküchle', price: 4.20 }
                    ]
                },
                {
                    id: 'r10',
                    name: 'Ganesha',
                    category: 'Indisch',
                    menu: [
                        { id: 'm46', name: 'Chicken Tikka Masala', price: 12.90 },
                        { id: 'm47', name: 'Lamb Vindaloo', price: 14.50 },
                        { id: 'm48', name: 'Vegetable Biryani', price: 10.90 },
                        { id: 'm49', name: 'Naan Brot', price: 3.50 },
                        { id: 'm50', name: 'Mango Lassi', price: 3.80 }
                    ]
                },
                {
                    id: 'r11',
                    name: 'KIYOMI',
                    category: 'Japanisch',
                    menu: [
                        { id: 'm51', name: 'Sushi Set (12 Stück)', price: 16.90 },
                        { id: 'm52', name: 'Ramen Tonkotsu', price: 11.50 },
                        { id: 'm53', name: 'Teriyaki Lachs', price: 13.90 },
                        { id: 'm54', name: 'Edamame', price: 4.50 },
                        { id: 'm55', name: 'Mochi Eis', price: 5.20 }
                    ]
                },
                {
                    id: 'r12',
                    name: 'Bella Pizza',
                    category: 'Italienisch',
                    menu: [
                        { id: 'm56', name: 'Pizza Diavola', price: 9.80 },
                        { id: 'm57', name: 'Pizza Quattro Stagioni', price: 11.50 },
                        { id: 'm58', name: 'Calzone Classico', price: 10.90 },
                        { id: 'm59', name: 'Bruschetta', price: 5.50 },
                        { id: 'm60', name: 'Gelato (3 Kugeln)', price: 4.80 }
                    ]
                },
                {
                    id: 'r13',
                    name: 'Curry 96',
                    category: 'Indisch',
                    menu: [
                        { id: 'm61', name: 'Butter Chicken', price: 11.90 },
                        { id: 'm62', name: 'Palak Paneer', price: 10.50 },
                        { id: 'm63', name: 'Chicken Madras', price: 12.50 },
                        { id: 'm64', name: 'Basmati Reis', price: 3.20 },
                        { id: 'm65', name: 'Kulfi Eis', price: 4.50 }
                    ]
                },
                {
                    id: 'r14',
                    name: 'Mauri Pizza',
                    category: 'Italienisch',
                    menu: [
                        { id: 'm66', name: 'Pizza Prosciutto', price: 10.50 },
                        { id: 'm67', name: 'Pizza Vegetariana', price: 9.90 },
                        { id: 'm68', name: 'Gnocchi Gorgonzola', price: 11.80 },
                        { id: 'm69', name: 'Insalata Caprese', price: 7.90 },
                        { id: 'm70', name: 'Cannoli Siciliani', price: 5.50 }
                    ]
                },
                {
                    id: 'r15',
                    name: 'Asia Food Dang VI',
                    category: 'Asiatisch',
                    menu: [
                        { id: 'm71', name: 'Gebratener Reis mit Garnelen', price: 10.80 },
                        { id: 'm72', name: 'Knusprige Ente', price: 13.90 },
                        { id: 'm73', name: 'Wan Tan Suppe', price: 5.50 },
                        { id: 'm74', name: 'Mapo Tofu', price: 9.50 },
                        { id: 'm75', name: 'Gebackene Banane', price: 4.20 }
                    ]
                }
            ],
            weekDays: ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'],
            votes: {},
            participants: {},
            orders: {},
            cart: {}, // will be restructured to { userId: { dayIndex: { itemId: {...} } } }
            orderHistory: {}, // { userId: [orders] }
            orderStatuses: {}, // { orderId: 'pending'|'paid'|'delivered' }
            users: {} // { userId: { id, name, email, password, role, createdAt } }
        };

        // JSON File Storage - adaptive paths for portability
        function getDataFilePath() {
            // Get current script location for adaptive path
            const currentScript = document.currentScript || document.scripts[document.scripts.length - 1];
            const currentPath = currentScript.src;
            const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
            
            // If running locally (file://) or no base path, use relative path
            if (currentPath.startsWith('file://') || !basePath || basePath === window.location.href) {
                return './data.json';
            }
            
            return basePath + 'data.json';
        }

        async function loadState() {
            // Check if we're running locally (file://) 
            if (window.location.protocol === 'file:') {
                console.warn('Running locally - cannot load JSON file via fetch()');
                showNotification('💻 Lokal geöffnet - verwende localStorage oder starten Sie einen Webserver', 'info');
                
                // Try to load from localStorage as fallback
                const saved = localStorage.getItem('geteat_state');
                if (saved) {
                    try {
                        const savedState = JSON.parse(saved);
                        Object.assign(state, savedState);
                        
                        // Entschlüssele Benutzerdaten falls vorhanden
                        if (state.users) {
                            state.users = decryptUserData(state.users);
                        }
                        
                        console.log('Data loaded from localStorage - User data decrypted');
                        showNotification('💾 Daten aus Browser-Speicher geladen - Benutzerdaten entschlüsselt', 'success');
                    } catch (e) {
                        console.error('Failed to load from localStorage:', e);
                        ensureDefaultStructure();
                    }
                } else {
                    ensureDefaultStructure();
                }
                
                // Ensure default structure exists after loading
                ensureDefaultStructure();
                
                // Always reset currentUser on page load - no auto-login
                state.currentUser = null;
                return;
            }

            // Normal JSON loading for web servers
            try {
                const dataPath = getDataFilePath();
                console.log('Loading data from:', dataPath);
                
                const response = await fetch(dataPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const savedState = await response.json();
                
                // Remove documentation from state
                const { _documentation, ...actualState } = savedState;
                Object.assign(state, actualState);
                
                // Entschlüssele Benutzerdaten falls vorhanden
                if (state.users) {
                    state.users = decryptUserData(state.users);
                }
                
                console.log('Data loaded successfully from JSON file - User data decrypted');
                
            } catch (e) {
                console.warn('Could not load JSON file, using default state:', e);
                
                // Ensure default structure exists
                ensureDefaultStructure();
            }
            
            // Ensure default structure exists after loading
            ensureDefaultStructure();
            
            // Always reset currentUser on page load - no auto-login
            state.currentUser = null;
        }

        function ensureDefaultStructure() {
            if (!state.adminSettings) {
                state.adminSettings = {};
            }
            if (!state.adminSettings.paypalCodes) {
                state.adminSettings.paypalCodes = {};
            }
            if (!state.adminSettings.pickupPersons) {
                state.adminSettings.pickupPersons = {};
            }
            if (!state.adminSettings.orderingEnabled) {
                state.adminSettings.orderingEnabled = { 0: true, 1: true, 2: true, 3: true, 4: true };
            }
            if (!state.adminSettings.editingEnabled) {
                state.adminSettings.editingEnabled = { 0: true, 1: true, 2: true, 3: true, 4: true };
            }
            if (!state.adminSettings.daysVisible) {
                state.adminSettings.daysVisible = { 0: true, 1: true, 2: true, 3: true, 4: true };
            }
            if (!state.adminSettings.allowedAdmins) {
                state.adminSettings.allowedAdmins = ['administrator', 'admin', 'chef'];
            }
            if (!state.adminSettings.dailyRestaurants) {
                state.adminSettings.dailyRestaurants = {};
            }
            if (!state.adminSettings.savedPersons) {
                state.adminSettings.savedPersons = {};
            }
            if (!state.adminSettings.personsList) {
                state.adminSettings.personsList = [];
            }
            
            // Migrate cart structure to be user-specific
        function migrateCartToUserSpecific() {
            // Check if cart structure needs migration (old structure: cart[dayIndex])
            if (state.cart && Object.keys(state.cart).length > 0) {
                const firstKey = Object.keys(state.cart)[0];
                // If first key is a day index (number) instead of user ID, migrate
                if (!isNaN(firstKey)) {
                    console.log('Migrating cart structure to user-specific format');
                    const oldCart = { ...state.cart };
                    state.cart = {};
                    // Move old cart data to a temporary user (will be cleared on login)
                    if (Object.keys(oldCart).length > 0) {
                        state.cart['temp'] = oldCart;
                    }
                }
            }
        }

        // Get user-specific cart
        function getUserCart() {
            if (!state.currentUser) {
                return {};
            }
            if (!state.cart[state.currentUser.id]) {
                state.cart[state.currentUser.id] = {};
            }
            return state.cart[state.currentUser.id];
        }
        
        // Make getUserCart immediately available globally
        window.getUserCart = getUserCart;

        // Clear cart for current user
        function clearUserCart() {
            if (state.currentUser) {
                state.cart[state.currentUser.id] = {};
            }
        }

            // Ensure users object exists
            if (!state.users) {
                state.users = {};
            }
            
            // Ensure core state objects exist
            if (!state.restaurants) {
                state.restaurants = [];
            }
            if (!state.votes) {
                state.votes = {};
            }
            if (!state.participants) {
                state.participants = {};
            }
            if (!state.orders) {
                state.orders = {};
            }
            if (!state.cart) {
                state.cart = {};
            }
            // Migrate cart structure to be user-specific
            migrateCartToUserSpecific();
            if (!state.orderHistory) {
                state.orderHistory = {};
            }
            if (!state.orderStatuses) {
                state.orderStatuses = {};
            }
            
            // Ensure weekDays is preserved
            if (!state.weekDays || state.weekDays.length === 0) {
                state.weekDays = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
            }
        }

        // Verschlüsselungsfunktionen für Benutzerdaten
        const ENCRYPTION_KEY = 'GetEat_Secure_2024_Key_Protection';
        
        function simpleEncrypt(text, key = ENCRYPTION_KEY) {
            if (!text) return text;
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                result += String.fromCharCode(charCode);
            }
            return btoa(result); // Base64 kodieren
        }
        
        function simpleDecrypt(encryptedText, key = ENCRYPTION_KEY) {
            if (!encryptedText) return encryptedText;
            try {
                const decoded = atob(encryptedText); // Base64 dekodieren
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    result += String.fromCharCode(charCode);
                }
                return result;
            } catch (e) {
                console.warn('Decryption failed, returning original text:', e);
                return encryptedText; // Fallback bei Fehlern
            }
        }
        
        // Benutzerdaten verschlüsseln
        function encryptUserData(users) {
            if (!users || typeof users !== 'object') return users;
            
            const encryptedUsers = {};
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                encryptedUsers[userId] = {
                    ...user,
                    name: simpleEncrypt(user.name),
                    email: simpleEncrypt(user.email),
                    password: simpleEncrypt(user.password)
                };
            });
            return encryptedUsers;
        }
        
        // Benutzerdaten entschlüsseln
        function decryptUserData(encryptedUsers) {
            if (!encryptedUsers || typeof encryptedUsers !== 'object') return encryptedUsers;
            
            const decryptedUsers = {};
            Object.keys(encryptedUsers).forEach(userId => {
                const user = encryptedUsers[userId];
                decryptedUsers[userId] = {
                    ...user,
                    name: simpleDecrypt(user.name),
                    email: simpleDecrypt(user.email),
                    password: simpleDecrypt(user.password)
                };
            });
            return decryptedUsers;
        }

        // Queue für offline Speicherung
        let saveQueue = JSON.parse(localStorage.getItem('geteat_save_queue') || '[]');
        let isProcessingQueue = false;
        
        // Mehrbenutzer-Synchronisation
        let lastSyncTimestamp = Date.now();
        let syncInterval = null;
        
        // Save throttling für Race Condition Prevention
        let pendingSave = null;
        let saveTimeout = null;
        const SAVE_DEBOUNCE_MS = 500; // 500ms debounce für Speichervorgänge
        
        // Optimistic locking für kritische Operationen
        let lastStateHash = null;
        
        // Berechne Hash für State-Vergleich
        function calculateStateHash(stateObj) {
            return btoa(JSON.stringify(stateObj)).substring(0, 16);
        }
        
        // Automatische Synchronisation alle 10 Sekunden
        function startAutoSync() {
            if (syncInterval) return; // Bereits gestartet
            
            syncInterval = setInterval(async () => {
                await syncWithServer();
            }, 10000); // 10 Sekunden
        }
        
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }
        
        // Synchronisation mit Server
        async function syncWithServer() {
            if (window.location.protocol === 'file:') return; // Nur bei Server-Modus
            
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lastSync: lastSyncTimestamp })
                });
                
                if (response.ok) {
                    const syncData = await response.json();
                    if (syncData.hasUpdates) {
                        // Server hat neuere Daten
                        const currentUser = state.currentUser; // Benutzer merken
                        Object.assign(state, syncData.data);
                        
                        // Benutzerdaten entschlüsseln
                        if (state.users) {
                            state.users = decryptUserData(state.users);
                        }
                        
                        state.currentUser = currentUser; // Benutzer wiederherstellen
                        lastSyncTimestamp = syncData.timestamp;
                        
                        // UI aktualisieren falls nötig
                        if (state.currentRoute === 'voting') renderWeekGrid();
                        if (state.currentRoute === 'admin') renderAdmin();
                        
                        console.log('Data synced from server');
                    }
                }
            } catch (error) {
                console.warn('Sync failed:', error);
            }
        }

        async function saveState(forceImmediate = false) {
            // Debounce für häufige Speichervorgänge (außer bei forceImmediate)
            if (!forceImmediate) {
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                saveTimeout = setTimeout(() => {
                    saveStateImmediate();
                }, SAVE_DEBOUNCE_MS);
                return;
            }
            
            return saveStateImmediate();
        }
        
        async function saveStateImmediate() {
            try {
                // Verhindere parallele Speichervorgänge
                if (pendingSave) {
                    return pendingSave;
                }
                
                // Erstelle eine Kopie des States mit verschlüsselten Benutzerdaten
                const stateToSave = { ...state };
                if (stateToSave.users) {
                    stateToSave.users = encryptUserData(stateToSave.users);
                }
                
                // Berechne Hash für Optimistic Locking
                const currentHash = calculateStateHash(stateToSave);
                
                pendingSave = performSave(stateToSave, currentHash);
                const result = await pendingSave;
                pendingSave = null;
                
                return result;
            } catch (error) {
                pendingSave = null;
                throw error;
            }
        }
        
        async function performSave(stateToSave, currentHash) {
            try {
                // Prepare data with documentation und Concurrency Control
                const dataToSave = {
                    _metadata: {
                        timestamp: Date.now(),
                        hash: currentHash,
                        userId: state.currentUser?.id || 'anonymous',
                        lastHash: lastStateHash
                    },
                    _documentation: {
                        description: "GetEat App Datenbank - Alle Anwendungsdaten werden hier gespeichert",
                        version: "1.0.0",
                        lastUpdated: new Date().toISOString(),
                        security: "Benutzerdaten (Name, E-Mail, Passwort) sind verschlüsselt",
                        structure: {
                            adminSettings: "Administrator-Einstellungen und Konfiguration",
                            restaurants: "Liste aller verfügbaren Restaurants mit Menüs",
                            weekDays: "Wochentage für die Planung (Montag-Freitag)",
                            votes: "Abstimmungen pro Tag und Restaurant",
                            participants: "Teilnehmer pro Wochentag",
                            orders: "Alle Bestellungen organisiert nach Wochentagen",
                            cart: "Aktuelle Warenkörbe der Benutzer",
                            orderHistory: "Bestellhistorie pro Benutzer",
                            orderStatuses: "Status der Bestellungen (pending/paid/delivered)",
                            users: "Registrierte Benutzer mit verschlüsselten Credentials"
                        }
                    },
                    ...stateToSave
                };

                // If running locally (file://), fall back to localStorage
                if (window.location.protocol === 'file:') {
                    localStorage.setItem('geteat_state', JSON.stringify(stateToSave));
                    console.log('State saved to localStorage (local mode) - User data encrypted');
                    showNotification('💾 Daten im Browser gespeichert (lokaler Modus) - Benutzerdaten verschlüsselt', 'info');
                    return;
                }

                // Try to save to server via API
                try {
                    const response = await fetch('/api/save-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSave)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // Check für Konflikte (wenn Server neuere Daten hat)
                    if (result.conflict) {
                        console.warn('⚠️ Konflikt erkannt - Server hat neuere Daten');
                        showNotification('⚠️ Konflikt: Ihre Änderungen konnten nicht gespeichert werden. Seite wird neu geladen.', 'warning');
                        setTimeout(() => location.reload(), 3000);
                        return;
                    }
                    
                    lastStateHash = currentHash;
                    console.log('Data saved to server:', result.message);
                    
                    // Process any queued saves after successful connection
                    processQueuedSaves();
                    
                } catch (serverError) {
                    console.warn('Server save failed, adding to queue:', serverError);
                    
                    // Add to queue for later sync
                    const queueItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        data: dataToSave
                    };
                    
                    saveQueue.push(queueItem);
                    localStorage.setItem('geteat_save_queue', JSON.stringify(saveQueue));
                    localStorage.setItem('geteat_state', JSON.stringify(stateToSave));
                    
                    const queueLength = saveQueue.length;
                    showNotification(`📡 Server offline - lokal gespeichert (${queueLength} ausstehend)`, 'warning');
                }
                
            } catch (e) {
                console.error('Failed to save state:', e);
                showNotification('❌ Fehler beim Speichern der Daten.', 'error');
            }
        }

        // Queue verarbeiten wenn Server wieder verfügbar
        async function processQueuedSaves() {
            if (isProcessingQueue || saveQueue.length === 0) return;
            
            isProcessingQueue = true;
            console.log(`🔄 Verarbeite ${saveQueue.length} ausstehende Speicherungen...`);
            
            const processedItems = [];
            
            for (const item of saveQueue) {
                try {
                    const response = await fetch('/api/save-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(item.data)
                    });

                    if (response.ok) {
                        processedItems.push(item.id);
                        console.log(`✅ Queue-Item ${item.id} erfolgreich hochgeladen`);
                    } else {
                        console.warn(`❌ Queue-Item ${item.id} fehlgeschlagen:`, response.status);
                        break; // Stop processing if server fails
                    }
                } catch (error) {
                    console.warn('Queue processing failed:', error);
                    break; // Stop processing on error
                }
            }
            
            // Remove processed items from queue
            if (processedItems.length > 0) {
                saveQueue = saveQueue.filter(item => !processedItems.includes(item.id));
                localStorage.setItem('geteat_save_queue', JSON.stringify(saveQueue));
                
                const remaining = saveQueue.length;
                if (remaining === 0) {
                    showNotification('✅ Alle ausstehenden Änderungen hochgeladen!', 'success');
                } else {
                    showNotification(`🔄 ${processedItems.length} hochgeladen, ${remaining} ausstehend`, 'info');
                }
            }
            
            isProcessingQueue = false;
        }

        // Periodisch prüfen ob Server wieder verfügbar ist
        setInterval(async () => {
            if (saveQueue.length > 0 && !isProcessingQueue) {
                try {
                    const response = await fetch('/api/save-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ _ping: true })
                    });
                    
                    if (response.ok) {
                        processQueuedSaves();
                    }
                } catch (e) {
                    // Server still offline, keep waiting
                }
            }
        }, 30000); // Check every 30 seconds

        // Notification system for save feedback
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: var(--space) var(--space-lg);
                border-radius: var(--radius);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                max-width: 400px;
                font-size: 0.875rem;
                line-height: 1.4;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Add CSS for notification animations
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(notificationStyles);

        // Routing
        function showRoute(routeName) {
            // Hide all routes
            document.querySelectorAll('.route').forEach(route => {
                route.classList.remove('active');
            });

            // Show target route
            const targetRoute = document.getElementById(routeName);
            if (targetRoute) {
                targetRoute.classList.add('active');
            }

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-route="${routeName}"]`)?.classList.add('active');

            // Admin dashboard centering
            if (routeName === 'admin') {
                // Prevent any scrolling on the admin page
                document.body.style.overflow = 'hidden';
            } else {
                // Restore scrolling when leaving admin
                document.body.style.overflow = '';
            }

            // Add/remove admin-active class on app container
            const app = document.querySelector('.app');
            if (routeName === 'admin') {
                app.classList.add('admin-active');
            } else {
                app.classList.remove('admin-active');
            }

            state.currentRoute = routeName;

            // Route-specific initialization
            if (routeName === 'voting') renderWeekGrid();
            if (routeName === 'profile') renderProfile();
            if (routeName === 'admin') renderAdmin();
        }


        // Authentication
        function login(email, password) {
            // Check if manual admin login
            if (email === 'admin' && password === 'admin123') {
                state.currentUser = {
                    id: 'admin_manual',
                    name: 'Administrator',
                    email: 'admin@local',
                    role: 'admin'
                };
                
                // Clear any temporary cart data when admin logs in
                if (state.cart['temp']) {
                    delete state.cart['temp'];
                }
                
                saveState();
                showRoute('admin');
                return true;
            }

            // Initialize users object if not exists
            if (!state.users) {
                state.users = {};
            }

            // Find user by email
            const user = Object.values(state.users).find(u => u.email === email);
            
            if (user && user.password === password) {
                state.currentUser = {
                    id: user.id,
                    name: user.name,
                    email: user.email,
                    role: user.role || 'user'
                };
                
                // Clear any temporary cart data when user logs in
                if (state.cart['temp']) {
                    delete state.cart['temp'];
                }
                
                saveState();
                
                // Redirect based on role
                if (user.role === 'admin') {
                    showRoute('admin');
                } else {
                    showRoute('voting');
                }
                return true;
            }

            return false;
        }

        function register(name, email, password) {
            // Validate input
            if (!name || !name.trim()) {
                alert('Bitte geben Sie einen Namen ein.');
                return false;
            }

            if (!email || !email.trim()) {
                alert('Bitte geben Sie eine E-Mail-Adresse ein.');
                return false;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Bitte geben Sie eine gültige E-Mail-Adresse ein.');
                return false;
            }

            if (!password || password.length < 6) {
                alert('Das Passwort muss mindestens 6 Zeichen lang sein.');
                return false;
            }

            // Initialize users object if not exists
            if (!state.users) {
                state.users = {};
            }

            // Check if email already exists
            const existingUser = Object.values(state.users).find(u => u.email === email);
            if (existingUser) {
                alert('Diese E-Mail-Adresse ist bereits registriert. Bitte verwenden Sie eine andere E-Mail-Adresse oder melden Sie sich an.');
                return false;
            }

            // Create new user
            const userId = 'u' + Date.now();
            const newUser = {
                id: userId,
                name: name.trim(),
                email: email.trim().toLowerCase(),
                password: password,
                role: 'user',
                createdAt: new Date().toISOString()
            };

            state.users[userId] = newUser;
            state.currentUser = {
                id: newUser.id,
                name: newUser.name,
                email: newUser.email,
                role: newUser.role
            };

            // Clear any temporary cart data when user registers
            if (state.cart['temp']) {
                delete state.cart['temp'];
            }

            saveState();
            showRoute('voting');
            return true;
        }

        function logout() {
            state.currentUser = null;
            saveState();
            showRoute('home');
            updateUI();
            // Clear cart summary when logging out
            const cartSummary = document.getElementById('cartSummary');
            if (cartSummary) {
                cartSummary.innerHTML = '<p class="text-muted">Warenkorb ist leer</p>';
            }
        }

        // Voting System
        function vote(dayIndex, restaurantId) {
            if (!state.currentUser) {
                alert('Bitte melden Sie sich an, um abzustimmen.');
                showRoute('login');
                return;
            }

            if (!state.votes[dayIndex]) state.votes[dayIndex] = {};

            // Remove previous vote from this user
            Object.keys(state.votes[dayIndex]).forEach(rid => {
                if (state.votes[dayIndex][rid] && state.votes[dayIndex][rid].includes(state.currentUser.id)) {
                    state.votes[dayIndex][rid] = state.votes[dayIndex][rid].filter(uid => uid !== state.currentUser.id);
                    if (state.votes[dayIndex][rid].length === 0) {
                        delete state.votes[dayIndex][rid];
                    }
                }
            });

            // Add new vote
            if (!state.votes[dayIndex][restaurantId]) {
                state.votes[dayIndex][restaurantId] = [];
            }
            state.votes[dayIndex][restaurantId].push(state.currentUser.id);

            saveState(true); // Sofortiges Speichern für kritische Voting-Operation
            renderWeekGrid();
        }

        function joinDay(dayIndex) {
            if (!state.currentUser) {
                alert('Bitte melden Sie sich an, um teilzunehmen.');
                showRoute('login');
                return;
            }

            if (!state.participants[dayIndex]) state.participants[dayIndex] = [];

            if (!state.participants[dayIndex].includes(state.currentUser.id)) {
                state.participants[dayIndex].push(state.currentUser.id);
                saveState(true); // Sofortiges Speichern für kritische Join-Operation
                renderWeekGrid();
            }
        }

        function showMenu(dayIndex) {
            if (!state.currentUser) {
                alert('Bitte melden Sie sich an, um zu bestellen.');
                showRoute('login');
                return;
            }

            const orderSection = document.getElementById('orderSection');
            const orderDay = document.getElementById('orderDay');
            const menuGrid = document.getElementById('menuGrid');

            orderDay.textContent = state.weekDays[dayIndex];
            orderSection.style.display = 'block';
            menuGrid.innerHTML = '';

            // Get winning restaurant or show all
            const dayVotes = state.votes[dayIndex] || {};
            let maxVotes = 0;
            let winningRestaurant = null;

            Object.entries(dayVotes).forEach(([rid, voters]) => {
                if (voters && voters.length > maxVotes) {
                    maxVotes = voters.length;
                    winningRestaurant = rid;
                }
            });

            const restaurantsToShow = winningRestaurant
                ? state.restaurants.filter(r => r.id === winningRestaurant)
                : state.restaurants;

            restaurantsToShow.forEach(restaurant => {
                restaurant.menu.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'card';
                    menuItem.style.padding = '16px';
                    menuItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4>${item.name}</h4>
                                <p class="text-muted">${restaurant.name}</p>
                                <p style="color: var(--accent); font-weight: 600;">€${item.price.toFixed(2)}</p>
                            </div>
                            <button class="btn btn-primary" onclick="showAddToCartModal('${item.id}', '${restaurant.id}', ${dayIndex})">
                                Hinzufügen
                            </button>
                        </div>
                    `;
                    menuGrid.appendChild(menuItem);
                });
            });

            updateCartSummary(dayIndex);
            orderSection.scrollIntoView({ behavior: 'smooth' });
        }

        function addToCart(itemId, restaurantId, dayIndex) {
            addToCartWithWish(itemId, restaurantId, dayIndex, '');
        }
        
        function addToCartWithWish(itemId, restaurantId, dayIndex, extraWish) {
            console.log('🛒 addToCartWithWish called with:', itemId, restaurantId, dayIndex, extraWish);
            
            if (!state.currentUser) {
                console.log('🛒 No current user, redirecting to login');
                alert('Bitte melden Sie sich an, um Artikel zum Warenkorb hinzuzufügen.');
                showRoute('login');
                return;
            }
            
            console.log('🛒 Current user:', state.currentUser);

            const userCart = getUserCart();
            if (!userCart[dayIndex]) userCart[dayIndex] = {};
            
            // Neue Struktur: cart[userId][dayIndex][itemId] = { quantity: number, extraWishes: [string] }
            if (!userCart[dayIndex][itemId]) {
                userCart[dayIndex][itemId] = { quantity: 0, extraWishes: [] };
            }
            
            // Falls alte Struktur (nur Zahl) vorhanden, konvertieren
            if (typeof userCart[dayIndex][itemId] === 'number') {
                const oldQuantity = userCart[dayIndex][itemId];
                userCart[dayIndex][itemId] = { quantity: oldQuantity, extraWishes: [] };
            }

            userCart[dayIndex][itemId].quantity++;
            
            // Extrawunsch hinzufügen falls vorhanden
            if (extraWish && extraWish.trim()) {
                userCart[dayIndex][itemId].extraWishes.push(extraWish.trim());
            }

            saveState();
            updateCartSummary(dayIndex);
        }

        function updateCartSummary(dayIndex) {
            const cartSummary = document.getElementById('cartSummary');
            const userCart = getUserCart();
            const cart = userCart[dayIndex] || {};
            
            if (Object.keys(cart).length === 0) {
                cartSummary.innerHTML = '<p class="text-muted">Warenkorb ist leer</p>';
                return;
            }

            let total = 0;
            let html = '<h4>Warenkorb</h4><div class="grid" style="gap: 8px;">';

            Object.entries(cart).forEach(([itemId, cartItem]) => {
                // Unterstützung für alte und neue Struktur
                const quantity = typeof cartItem === 'number' ? cartItem : cartItem.quantity;
                const extraWishes = typeof cartItem === 'object' ? (cartItem.extraWishes || []) : [];
                
                const item = findMenuItem(itemId);
                if (item && quantity > 0) {
                    const itemTotal = item.price * quantity;
                    total += itemTotal;
                    
                    // Extrawünsche für Anzeige formatieren
                    const extraWishesText = extraWishes.length > 0 
                        ? `<div style="font-size: 0.75rem; color: var(--text-accent); margin-top: 2px;">💬 ${extraWishes.join(', ')}</div>`
                        : '';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px; background: var(--surface); border-radius: 8px;">
                            <div style="flex: 1;">
                                <strong>${item.name}</strong>
                                <div class="text-muted">€${item.price.toFixed(2)} × ${quantity}</div>
                                ${extraWishesText}
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; margin-left: 8px;">
                                <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.75rem;" onclick="editExtraWishes('${itemId}', ${dayIndex})" title="Extrawünsche bearbeiten">✏️</button>
                                <button class="btn btn-ghost" style="padding: 4px 8px;" onclick="removeFromCart('${itemId}', ${dayIndex})">−</button>
                                <span>${quantity}</span>
                                <button class="btn btn-ghost" style="padding: 4px 8px;" onclick="addToCart('${itemId}', '', ${dayIndex})">+</button>
                            </div>
                        </div>
                    `;
                }
            });

            html += `</div>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Gesamt: €${total.toFixed(2)}</strong>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-ghost" onclick="clearCart(${dayIndex})">Leeren</button>
                            <button class="btn btn-primary" onclick="placeOrder(${dayIndex})" ${!isOrderingEnabled(dayIndex) ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                ${!isOrderingEnabled(dayIndex) ? '🔒 Bestellen gesperrt' : 'Bestellen'}
                            </button>
                        </div>
                    </div>
                </div>`;

            cartSummary.innerHTML = html;
        }

        function removeFromCart(itemId, dayIndex) {
            if (!state.currentUser) return;
            
            const userCart = getUserCart();
            if (userCart[dayIndex] && userCart[dayIndex][itemId]) {
                const cartItem = userCart[dayIndex][itemId];
                
                // Unterstützung für alte und neue Struktur
                if (typeof cartItem === 'number') {
                    userCart[dayIndex][itemId]--;
                    if (userCart[dayIndex][itemId] <= 0) {
                        delete userCart[dayIndex][itemId];
                    }
                } else {
                    cartItem.quantity--;
                    if (cartItem.quantity <= 0) {
                        delete userCart[dayIndex][itemId];
                    }
                }
                
                saveState();
                updateCartSummary(dayIndex);
            }
        }

        function clearCart(dayIndex) {
            if (!state.currentUser) return;
            
            if (confirm('Warenkorb wirklich leeren?')) {
                const userCart = getUserCart();
                userCart[dayIndex] = {};
                saveState();
                updateCartSummary(dayIndex);
            }
        }

        function placeOrder(dayIndex) {
            // Check if ordering is enabled for this day
            if (!isOrderingEnabled(dayIndex)) {
                alert('Bestellungen für diesen Tag sind noch nicht freigeschaltet.');
                return;
            }

            if (!state.currentUser) {
                alert('Bitte melden Sie sich an.');
                showRoute('login');
                return;
            }
            
            const userCart1 = getUserCart();
            const cart = userCart1[dayIndex] || {};
            if (Object.keys(cart).length === 0) {
                alert('Warenkorb ist leer');
                return;
            }

            if (!state.orders[dayIndex]) state.orders[dayIndex] = [];
            
            let total = 0;
            const orderItems = [];
            
            Object.entries(cart).forEach(([itemId, cartItem]) => {
                // Unterstützung für alte und neue Struktur
                const quantity = typeof cartItem === 'number' ? cartItem : cartItem.quantity;
                const extraWishes = typeof cartItem === 'object' ? (cartItem.extraWishes || []) : [];
                
                const item = findMenuItem(itemId);
                if (item && quantity > 0) {
                    total += item.price * quantity;
                    orderItems.push({ 
                        item: item, 
                        quantity: quantity,
                        extraWishes: extraWishes
                    });
                }
            });

            const order = {
                id: 'order_' + Date.now(),
                userId: state.currentUser.id,
                userName: state.currentUser.name,
                items: orderItems,
                total: total,
                timestamp: new Date().toISOString(),
                dayIndex: dayIndex,
                status: 'placed'
            };

            state.orders[dayIndex].push(order);
            
            // Add to user's order history
            if (!state.orderHistory[state.currentUser.id]) {
                state.orderHistory[state.currentUser.id] = [];
            }
            state.orderHistory[state.currentUser.id].push(order);

            const userCart2 = getUserCart();
            userCart2[dayIndex] = {};
            saveState(true); // Sofortiges Speichern für kritische Bestellungs-Operation

            // Show PayPal image and pickup info if available
            const paypalImage = state.adminSettings.paypalCodes[dayIndex];
            const pickupPerson = state.adminSettings.pickupPersons[dayIndex];
            
            let message = `Bestellung über €${total.toFixed(2)} wurde aufgegeben!`;
            
            if (pickupPerson) {
                message += `\n\nAbholung durch: ${pickupPerson}`;
            }
            
            // Prüfe auf Preisänderungen nach der Bestellung
            checkForPriceChanges(order);
            
            // Always show PayPal modal if image exists, immediately
            if (paypalImage) {
                showPayPalModal(dayIndex, order.id, total);
            } else {
                // Only show alert if no PayPal image available
                alert(message);
            }
            updateCartSummary(dayIndex);
        }

        // Prüfe auf Preisänderungen nach Bestellung
        function checkForPriceChanges(order) {
            const priceChanges = [];
            let totalDifference = 0;
            
            order.items.forEach(orderItem => {
                const currentItem = findMenuItem(orderItem.item.id);
                if (currentItem && currentItem.price !== orderItem.item.price) {
                    const difference = (currentItem.price - orderItem.item.price) * orderItem.quantity;
                    totalDifference += difference;
                    priceChanges.push({
                        name: orderItem.item.name,
                        oldPrice: orderItem.item.price,
                        newPrice: currentItem.price,
                        quantity: orderItem.quantity,
                        difference: difference
                    });
                }
            });
            
            if (priceChanges.length > 0) {
                showPriceChangeNotification(priceChanges, totalDifference, order);
            }
        }

        // Zeige Preisänderungs-Benachrichtigung
        function showPriceChangeNotification(priceChanges, totalDifference, order) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                display: flex; align-items: center; justify-content: center; 
                z-index: 1000; backdrop-filter: blur(8px);
            `;
            
            const changeType = totalDifference > 0 ? 'increase' : 'decrease';
            const icon = totalDifference > 0 ? '📈' : '📉';
            const color = totalDifference > 0 ? '#ef4444' : '#10b981';
            
            modal.innerHTML = `
                <div style="background: var(--surface); padding: var(--space-xl); border-radius: var(--radius-lg); max-width: 600px; width: 90vw; border: 1px solid var(--border); box-shadow: var(--shadow-lg);">
                    <div style="text-align: center; margin-bottom: var(--space-lg);">
                        <div style="font-size: 3rem; margin-bottom: var(--space-sm);">${icon}</div>
                        <h3 style="margin: 0; color: var(--text-primary);">Preisänderung erkannt!</h3>
                        <p style="color: var(--text-muted); margin: var(--space-xs) 0;">
                            Seit Ihrer Bestellung haben sich einige Preise geändert
                        </p>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        ${priceChanges.map(change => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--surface-hover); border-radius: var(--radius); margin-bottom: var(--space-xs);">
                                <div>
                                    <strong>${change.name}</strong>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                                        ${change.quantity}x • €${change.oldPrice.toFixed(2)} → €${change.newPrice.toFixed(2)}
                                    </div>
                                </div>
                                <div style="color: ${color}; font-weight: 600;">
                                    ${change.difference > 0 ? '+' : ''}€${change.difference.toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-lg); background: ${totalDifference > 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: var(--radius); margin-bottom: var(--space-lg);">
                        <div style="font-size: 1.25rem; font-weight: 600; color: ${color};">
                            Gesamt-Differenz: ${totalDifference > 0 ? '+' : ''}€${totalDifference.toFixed(2)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--space-xs);">
                            Ihre ursprüngliche Bestellung: €${order.total.toFixed(2)}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="this.closest('div').parentElement.remove()">
                            Verstanden
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Edit existing order (updated version)
        function editOrderOld(orderId, dayIndex) {
            const dayOrders = state.orders[dayIndex] || [];
            const order = dayOrders.find(o => o.id === orderId);
            
            if (!order || order.userId !== state.currentUser.id) {
                alert('Bestellung nicht gefunden oder nicht berechtigt');
                return;
            }

            // Move order items back to cart for editing
            if (!state.cart[dayIndex]) state.cart[dayIndex] = {};
            
            order.items.forEach(orderItem => {
                const menuItem = findMenuItemById(orderItem.item.id);
                if (menuItem) {
                    state.cart[dayIndex][orderItem.item.id] = orderItem.quantity;
                }
            });

            // Remove order from orders list
            const orderIndex = dayOrders.findIndex(o => o.id === orderId);
            if (orderIndex > -1) {
                dayOrders.splice(orderIndex, 1);
            }

            // Remove from user history
            const userHistory = state.orderHistory[state.currentUser.id] || [];
            const historyIndex = userHistory.findIndex(o => o.id === orderId);
            if (historyIndex > -1) {
                userHistory.splice(historyIndex, 1);
            }

            saveState();
            
            // Navigate to voting page and show menu
            showRoute('voting');
            setTimeout(() => showMenu(dayIndex), 100);
            
            alert('Bestellung wurde zum Bearbeiten in den Warenkorb gelegt');
        }

        function findMenuItemById(itemId) {
            for (const restaurant of state.restaurants) {
                const item = restaurant.menu.find(m => m.id === itemId);
                if (item) {
                    return { ...item, restaurantId: restaurant.id };
                }
            }
            return null;
        }

        function findMenuItem(itemId) {
            for (const restaurant of state.restaurants) {
                const item = restaurant.menu.find(m => m.id === itemId);
                if (item) {
                    return { ...item, restaurant: restaurant.name };
                }
            }
            return null;
        }

        // Render Functions
        function renderWeekGrid() {
            const grid = document.getElementById('weekGrid');
            if (!grid) return;
            
            grid.innerHTML = '';

            state.weekDays.forEach((day, index) => {
                // Prüfe ob Tag für Nutzer sichtbar ist (außer für Admins)
                const dayIsVisible = isDayVisible(index);
                if (state.currentUser?.role !== 'admin' && !dayIsVisible) {
                    return; // Tag überspringen für normale Nutzer
                }
                
                const dayVotes = state.votes[index] || {};
                const participants = state.participants[index] || [];
                
                // Calculate vote counts
                const voteCount = {};
                Object.entries(dayVotes).forEach(([rid, voters]) => {
                    if (voters && Array.isArray(voters)) {
                        voteCount[rid] = voters.length;
                    }
                });

                const maxVotes = Math.max(1, ...Object.values(voteCount));
                const winner = Object.entries(voteCount).reduce((a, b) => 
                    voteCount[a[0]] > voteCount[b[0]] ? a : b, ['', 0])[0];
                const winnerName = state.restaurants.find(r => r.id === winner)?.name || 'Noch kein Gewinner';

                const dayCard = document.createElement('div');
                dayCard.className = `day-card ${state.currentUser?.role === 'admin' && !dayIsVisible ? 'day-hidden' : ''}`;
                dayCard.innerHTML = `
                    <div class="day-header">
                        <h3 class="day-title">${day} ${state.currentUser?.role === 'admin' && !dayIsVisible ? '🙈' : ''}</h3>
                        <p class="day-info">${participants.length} Teilnehmer • ${winnerName}${state.currentUser?.role === 'admin' && !dayIsVisible ? ' (versteckt für Nutzer)' : ''}</p>
                    </div>
                    <div class="day-actions">
                        <button class="btn btn-ghost" onclick="joinDay(${index})">Teilnehmen</button>
                        <button class="btn btn-secondary" onclick="showMenu(${index})">Bestellen</button>
                    </div>
                    <div class="voting-section">
                        ${(() => {
                            try {
                                const dailyRestaurants = getDailyRestaurants(index);
                                if (!dailyRestaurants || dailyRestaurants.length === 0) {
                                    return '<div style="text-align: center; color: var(--text-muted); padding: var(--space-lg);">Keine Restaurants verfügbar</div>';
                                }
                                
                                return dailyRestaurants.map(restaurant => {
                                    if (!restaurant) return '';
                                    const votes = voteCount[restaurant.id] || 0;
                                    const percentage = maxVotes > 0 ? (votes / maxVotes) * 100 : 0;
                                    return `
                                        <div class="restaurant-vote">
                                            <div class="restaurant-info">
                                                <div class="restaurant-name">${restaurant.name || 'Unbekannt'}</div>
                                                <div class="restaurant-category">${restaurant.category || 'Kategorie'}</div>
                                                <div class="vote-count">${votes} Stimmen</div>
                                                <div class="vote-bar">
                                                    <div class="vote-progress" style="width: ${percentage}%"></div>
                                                </div>
                                            </div>
                                            <button class="vote-button" onclick="vote(${index}, '${restaurant.id}')">Voten</button>
                                        </div>
                                    `;
                                }).join('');
                            } catch (error) {
                                console.error('Error rendering restaurants:', error);
                                return '<div style="text-align: center; color: var(--text-muted); padding: var(--space-lg);">Fehler beim Laden der Restaurants</div>';
                            }
                        })()}
                        ${state.currentUser?.role === 'admin' ? `
                            <div class="admin-restaurant-controls">
                                <button class="btn btn-ghost btn-sm" onclick="showRestaurantSelector(${index})">
                                    🏪 Restaurants auswählen
                                </button>
                            </div>
                        ` : ''}
                        
                        ${(() => {
                            if (!state.currentUser) return '';
                            
                            // Finde Bestellungen des aktuellen Users für diesen Tag
                            const dayOrders = state.orders[index] || [];
                            const userOrders = dayOrders.filter(order => order.userId === state.currentUser.id);
                            
                            if (userOrders.length === 0) return '';
                            
                            return `
                                <div class="user-orders-section" style="margin-top: var(--space); border-top: 1px solid var(--border); padding-top: var(--space);">
                                    <h4 style="margin: 0 0 var(--space-sm) 0; color: var(--text-primary); font-size: 0.875rem;">📦 Meine Bestellungen</h4>
                                    ${userOrders.map(order => `
                                        <div class="user-order-card" style="background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-sm); margin-bottom: var(--space-xs);">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-xs);">
                                                <div>
                                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.875rem;">€${order.total.toFixed(2)}</div>
                                                    <div style="font-size: 0.75rem; color: var(--text-muted);">#${order.id.slice(-6)}</div>
                                                </div>
                                                <div style="display: flex; gap: var(--space-xs);">
                                                    <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.7rem;" onclick="editOrder('${order.id}', ${index})" ${!isEditingEnabled(index) ? 'disabled title="Bestellbearbeitung gesperrt"' : ''}>✏️</button>
                                                    <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.7rem; color: #ef4444;" onclick="cancelOrder('${order.id}', ${index})">🗑️</button>
                                                </div>
                                            </div>
                                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                                ${order.items.slice(0, 2).map(item => `${item.quantity}x ${item.item.name}`).join(', ')}
                                                ${order.items.length > 2 ? ` +${order.items.length - 2} weitere` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        })()}
                    </div>
                `;

                grid.appendChild(dayCard);
            });
        }

        function renderProfile() {
            const nameEl = document.getElementById('userName');
            const emailEl = document.getElementById('userEmail');
            const roleEl = document.getElementById('userRole');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminMenuItem = document.getElementById('adminMenuItem');
            const loginMenuItem = document.getElementById('loginMenuItem');
            const registerMenuItem = document.getElementById('registerMenuItem');

            if (state.currentUser) {
                nameEl.textContent = state.currentUser.name;
                emailEl.textContent = state.currentUser.email;
                roleEl.textContent = `Rolle: ${state.currentUser.role === 'admin' ? 'Administrator' : 'Benutzer'}`;
                logoutBtn.style.display = 'block';
                loginMenuItem.style.display = 'none';
                registerMenuItem.style.display = 'none';

                if (state.currentUser.role === 'admin') {
                    adminMenuItem.style.display = 'block';
                }
            } else {
                nameEl.textContent = 'Nicht angemeldet';
                emailEl.textContent = '';
                roleEl.textContent = '';
                logoutBtn.style.display = 'none';
                adminMenuItem.style.display = 'none';
                loginMenuItem.style.display = 'block';
                registerMenuItem.style.display = 'block';
            }
        }

        function renderOrderHistory() {
            const section = document.getElementById('orderHistorySection');
            const list = document.getElementById('orderHistoryList');
            
            if (!section || !list) {
                console.error('Order history elements not found');
                return;
            }
            
            if (!state.currentUser) {
                section.style.display = 'none';
                return;
            }

            // Stelle sicher, dass orderHistory existiert
            if (!state.orderHistory) {
                state.orderHistory = {};
            }
            
            const userOrders = state.orderHistory[state.currentUser.id] || [];
            
            if (userOrders.length === 0) {
                list.innerHTML = '<div class="card"><p class="text-muted" style="text-align: center; padding: var(--space-lg);">🍽️ Noch keine Bestellungen vorhanden<br><small>Gehen Sie zum Voting-Bereich und bestellen Sie Ihr erstes Essen!</small></p></div>';
                return;
            }

            list.innerHTML = '';
            
            // Kopie erstellen um Original nicht zu verändern
            const ordersToShow = [...userOrders].reverse();
            
            ordersToShow.forEach(order => {
                try {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'card';
                    orderCard.style.padding = '16px';
                    
                    const dayName = state.weekDays[order.dayIndex] || 'Unbekannt';
                    const orderDate = order.timestamp ? new Date(order.timestamp).toLocaleDateString('de-DE') : 'Unbekannt';
                    const orderId = order.id || 'unknown';
                    const total = order.total || 0;
                    const items = order.items || [];
                    
                    orderCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div>
                                <h4>${dayName} - ${orderDate}</h4>
                                <p class="text-muted">Bestellung #${orderId.toString().slice(-6)}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="color: var(--accent); font-weight: 600;">€${total.toFixed(2)}</p>
                                <div style="display: flex; gap: var(--space-xs); justify-content: flex-end;">
                                    <button class="btn btn-ghost" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editOrder('${orderId}', ${order.dayIndex || 0})">✏️ Bearbeiten</button>
                                    <button class="btn btn-ghost" style="padding: 4px 8px; font-size: 0.75rem; color: #ef4444;" onclick="cancelOrder('${orderId}', ${order.dayIndex || 0})">🗑️ Stornieren</button>
                                </div>
                            </div>
                        </div>
                        <div class="grid" style="gap: 4px;">
                            ${items.map(item => {
                                const itemName = item?.item?.name || 'Unbekannt';
                                const itemPrice = item?.item?.price || 0;
                                const quantity = item?.quantity || 1;
                                const extraWishes = item?.extraWishes || [];
                                const extraWishesText = extraWishes.length > 0 
                                    ? `<div style="font-size: 0.75rem; color: var(--text-accent); margin-top: 2px;">💬 ${extraWishes.join(', ')}</div>`
                                    : '';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.875rem;">
                                        <div style="flex: 1;">
                                            <span>${quantity}x ${itemName}</span>
                                            ${extraWishesText}
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span>€${(itemPrice * quantity).toFixed(2)}</span>
                                            ${extraWishes.length > 0 ? `<button class="btn btn-ghost" style="padding: 1px 4px; font-size: 0.6rem;" onclick="viewExtraWishes('${orderId}', '${item.item?.id}', '${item.item?.name}', ${JSON.stringify(extraWishes).replace(/"/g, '&quot;')})" title="Extrawünsche anzeigen">💬</button>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    list.appendChild(orderCard);
                } catch (error) {
                    console.error('Error rendering order:', order, error);
                    // Füge eine Fehlerkarte hinzu
                    const errorCard = document.createElement('div');
                    errorCard.className = 'card';
                    errorCard.style.padding = '16px';
                    errorCard.innerHTML = '<p class="text-muted">⚠️ Fehler beim Laden dieser Bestellung</p>';
                    list.appendChild(errorCard);
                }
            });
        }

        function renderAdmin() {
            if (!state.currentUser || state.currentUser.role !== 'admin') {
                alert('Zugriff verweigert');
                showRoute('home');
                return;
            }

            // Gesamtstatistiken
            const statsEl = document.getElementById('adminStats');
            const totalUsers = new Set(Object.values(state.participants).flat()).size;
            const totalOrders = Object.values(state.orders).reduce((sum, dayOrders) => sum + dayOrders.length, 0);
            const totalRevenue = Object.values(state.orders).flat().reduce((sum, order) => sum + order.total, 0);

            statsEl.innerHTML = `
                <div class="grid" style="gap: 8px;">
                    <p>👥 Aktive Benutzer: <strong>${totalUsers}</strong></p>
                    <p>📦 Gesamtbestellungen: <strong>${totalOrders}</strong></p>
                    <p>💰 Gesamtumsatz: <strong>€${totalRevenue.toFixed(2)}</strong></p>
                    <p>🏪 Restaurants: <strong>${state.restaurants.length}</strong></p>
                </div>
            `;

            // Tagesstatistiken
            const dailyStatsEl = document.getElementById('dailyStats');
            let dailyStatsHTML = '<div class="grid" style="gap: 8px;">';
            
            state.weekDays.forEach((dayName, dayIndex) => {
                const dayOrders = state.orders[dayIndex] || [];
                const dayOrderCount = dayOrders.length;
                const dayRevenue = dayOrders.reduce((sum, order) => sum + order.total, 0);
                const dayParticipants = new Set(dayOrders.map(order => order.userId)).size;
                
                dailyStatsHTML += `
                    <div style="padding: var(--space-sm); background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
                        <h4 style="margin: 0 0 var(--space-xs) 0; color: var(--text-primary);">${dayName}</h4>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            <p style="margin: 2px 0;">📦 ${dayOrderCount} Bestellungen</p>
                            <p style="margin: 2px 0;">👥 ${dayParticipants} Teilnehmer</p>
                            <p style="margin: 2px 0; font-weight: 600; color: var(--accent);">💰 €${dayRevenue.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            });
            
            dailyStatsHTML += '</div>';
            dailyStatsEl.innerHTML = dailyStatsHTML;

            // Initialize all admin sections
            renderPickupManagement();
            renderRestaurantManagement();
            renderUserManagement();
            renderAdminSettings();
        }

        function updateUI() {
            renderProfile();
            if (state.currentRoute === 'voting') renderWeekGrid();
            if (state.currentRoute === 'admin') renderAdmin();
        }

        // Scrollbar Partikel-Effekt
        function createScrollParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'scroll-particle';
            particle.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                width: 4px;
                height: 4px;
                background: linear-gradient(45deg, var(--primary), var(--accent));
                border-radius: 50%;
                pointer-events: none;
                z-index: 9999;
                box-shadow: 0 0 6px rgba(139, 92, 246, 0.8);
                animation: scrollParticle 0.8s ease-out forwards;
            `;
            document.body.appendChild(particle);
            
            setTimeout(() => {
                particle.remove();
            }, 800);
        }

        // Scrollbar Tracking für Partikeleffekt
        let isScrolling = false;
        let scrollParticleTimer;

        function handleScrollParticles() {
            if (!isScrolling) {
                isScrolling = true;
                
                const createParticles = () => {
                    if (isScrolling) {
                        // Erstelle Partikel an der Scrollbar-Position
                        const scrollbarX = window.innerWidth - 15;
                        const scrollTop = window.pageYOffset;
                        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                        const scrollPercent = scrollTop / scrollHeight;
                        const scrollbarY = 50 + (window.innerHeight - 100) * scrollPercent;
                        
                        // Mehrere Partikel für besseren Effekt
                        for (let i = 0; i < 3; i++) {
                            setTimeout(() => {
                                createScrollParticle(
                                    scrollbarX + Math.random() * 10 - 5,
                                    scrollbarY + Math.random() * 20 - 10
                                );
                            }, i * 50);
                        }
                    }
                };
                
                createParticles();
                scrollParticleTimer = setInterval(createParticles, 100);
            }
            
            clearTimeout(scrollParticleTimer);
            scrollParticleTimer = setTimeout(() => {
                isScrolling = false;
                clearInterval(scrollParticleTimer);
            }, 150);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await loadState();
            
            // Starte automatische Synchronisation
            startAutoSync();
            
            // Scrollbar Partikel-Effekt aktivieren
            window.addEventListener('scroll', handleScrollParticles, { passive: true });
            
            // Container-Scrollbar Partikeleffekte
            const scrollableContainers = ['.menu-grid', '.admin-content', '.pickup-grid', '.restaurant-grid', '.order-list'];
            
            scrollableContainers.forEach(selector => {
                const containers = document.querySelectorAll(selector);
                containers.forEach(container => {
                    let containerScrolling = false;
                    let containerScrollTimer;
                    
                    container.addEventListener('scroll', () => {
                        if (!containerScrolling) {
                            containerScrolling = true;
                            
                            const createContainerParticles = () => {
                                if (containerScrolling) {
                                    const rect = container.getBoundingClientRect();
                                    const scrollbarX = rect.right - 8;
                                    const scrollTop = container.scrollTop;
                                    const scrollHeight = container.scrollHeight - container.clientHeight;
                                    const scrollPercent = scrollTop / scrollHeight;
                                    const scrollbarY = rect.top + 10 + (rect.height - 20) * scrollPercent;
                                    
                                    // Kleine Partikel für Container
                                    for (let i = 0; i < 2; i++) {
                                        setTimeout(() => {
                                            const particle = document.createElement('div');
                                            particle.style.cssText = `
                                                position: fixed;
                                                left: ${scrollbarX + Math.random() * 6 - 3}px;
                                                top: ${scrollbarY + Math.random() * 10 - 5}px;
                                                width: 3px;
                                                height: 3px;
                                                background: var(--primary-light);
                                                border-radius: 50%;
                                                pointer-events: none;
                                                z-index: 9998;
                                                box-shadow: 0 0 4px rgba(139, 92, 246, 0.6);
                                                animation: scrollParticle 0.6s ease-out forwards;
                                            `;
                                            document.body.appendChild(particle);
                                            
                                            setTimeout(() => particle.remove(), 600);
                                        }, i * 30);
                                    }
                                }
                            };
                            
                            createContainerParticles();
                            containerScrollTimer = setInterval(createContainerParticles, 120);
                        }
                        
                        clearTimeout(containerScrollTimer);
                        containerScrollTimer = setTimeout(() => {
                            containerScrolling = false;
                            clearInterval(containerScrollTimer);
                        }, 200);
                    }, { passive: true });
                });
            });


            // Header logo navigation
            const headerLogo = document.getElementById('headerLogo');
            if (headerLogo) {
                headerLogo.addEventListener('click', () => {
                    showRoute('home');
                });
            }

            // Burger menu controls
            const burgerMenu = document.getElementById('burgerMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            const menuPanel = document.getElementById('menuPanel');

            function openMenu() {
                burgerMenu.classList.add('open');
                menuOverlay.classList.add('open');
                menuPanel.classList.add('open');
            }

            function closeMenuFunc() {
                burgerMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
                menuPanel.classList.remove('open');
            }

            function toggleMenu() {
                if (burgerMenu.classList.contains('open')) {
                    closeMenuFunc();
                } else {
                    openMenu();
                }
            }

            burgerMenu.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', closeMenuFunc);

            // Navigation
            document.querySelectorAll('[data-route]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showRoute(btn.dataset.route);
                    closeMenuFunc(); // Close menu when navigating
                });
            });

            // Admin tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.admin-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById('admin-' + tab.dataset.tab).style.display = 'block';
                    
                    // Render specific admin content
                    if (tab.dataset.tab === 'pickup') renderPickupManagement();
                    if (tab.dataset.tab === 'restaurants') renderRestaurantManagement();
                    if (tab.dataset.tab === 'users') renderUserManagement();
                    if (tab.dataset.tab === 'orders') {
                        renderOrderManagement();
                        // Initialize date filter after rendering
                        setTimeout(initOrderDateFilter, 0);
                    }
                    if (tab.dataset.tab === 'settings') renderAdminSettings();
                });
            });

            // Login form
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (login(email, password)) {
                    alert('Erfolgreich angemeldet!');
                    updateUI();
                } else {
                    alert('Anmeldung fehlgeschlagen. Überprüfen Sie E-Mail und Passwort.');
                }
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;

                if (register(name, email, password)) {
                    alert('Erfolgreich registriert!');
                    updateUI();
                }
                // Error messages are handled in the register function
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Order History
            document.getElementById('showOrderHistory').addEventListener('click', () => {
                const section = document.getElementById('orderHistorySection');
                const isVisible = section.style.display !== 'none';
                section.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    renderOrderHistory();
                }
            });

            // Password Change
            document.getElementById('changePassword').addEventListener('click', () => {
                showChangePasswordModal();
            });

            // Notifications
            document.getElementById('enableNotifications').addEventListener('click', async () => {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    alert(`Benachrichtigungen: ${permission}`);
                } else {
                    alert('Benachrichtigungen werden von diesem Browser nicht unterstützt.');
                }
            });

            // Admin functions
            document.getElementById('exportOrders').addEventListener('click', () => {
                const orders = Object.values(state.orders).flat();
                if (orders.length === 0) {
                    alert('Keine Bestellungen zum Export vorhanden.');
                    return;
                }

                let csv = 'Tag,Benutzer,Artikel,Menge,Preis,Gesamt,PayPal Code\n';
                Object.entries(state.orders).forEach(([dayIndex, dayOrders]) => {
                    const dayName = state.weekDays[dayIndex];
                    const paypalCode = state.adminSettings.paypalCodes[dayIndex] || '';
                    dayOrders.forEach(order => {
                        order.items.forEach(orderItem => {
                            csv += `"${dayName}","${order.userName}","${orderItem.item.name}",${orderItem.quantity},${orderItem.item.price},${(orderItem.item.price * orderItem.quantity).toFixed(2)},"${paypalCode}"\n`;
                        });
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'bestellungen.csv';
                link.click();
            });

            document.getElementById('exportVotes').addEventListener('click', () => {
                let csv = 'Tag,Restaurant,Stimmen\n';
                Object.entries(state.votes).forEach(([dayIndex, dayVotes]) => {
                    const dayName = state.weekDays[dayIndex];
                    Object.entries(dayVotes).forEach(([rid, voters]) => {
                        const restaurant = state.restaurants.find(r => r.id === rid);
                        if (restaurant && voters) {
                            csv += `"${dayName}","${restaurant.name}",${voters.length}\n`;
                        }
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'voting.csv';
                link.click();
            });

            document.getElementById('sendPush').addEventListener('click', () => {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('GetEat Erinnerung', {
                        body: 'Vergiss nicht, für heute abzustimmen und zu bestellen!',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%236366f1"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="30">🍽️</text></svg>'
                    });
                } else {
                    alert('Benachrichtigungen sind nicht aktiviert.');
                }
            });

            // Initialize
            updateUI();
        });

        // Admin render functions
        function renderPickupManagement() {
            const container = document.getElementById('pickupManagement');
            if (!container) {
                console.error('pickupManagement container not found');
                return;
            }
            
            container.innerHTML = '';

            // Ensure default structure exists
            ensureDefaultStructure();

            if (!state.weekDays || state.weekDays.length === 0) {
                container.innerHTML = '<div class="card"><p class="text-muted" style="text-align: center; padding: var(--space-lg);">⚠️ Keine Wochentage konfiguriert</p></div>';
                return;
            }

            if (!state.adminSettings) {
                container.innerHTML = '<div class="card"><p class="text-muted" style="text-align: center; padding: var(--space-lg);">⏳ Admin-Einstellungen werden geladen...</p></div>';
                return;
            }

            state.weekDays.forEach((day, index) => {
                const card = document.createElement('div');
                card.className = 'pickup-card';
                
                const paypalCode = state.adminSettings.paypalCodes[index] || '';
                const pickupPerson = state.adminSettings.pickupPersons[index] || '';
                
                const orderingEnabled = state.adminSettings.orderingEnabled[index] === true;
                const editingEnabled = state.adminSettings.editingEnabled[index] === true;
                const dayVisible = state.adminSettings.daysVisible[index] === true;
                const votesCount = state.votes[index] ? Object.keys(state.votes[index]).length : 0;
                
                card.innerHTML = `
                    <h4>${day}</h4>
                    <div class="pickup-info">
                        <div class="field">
                            <label>🔓 Bestellungen freischalten</label>
                            <div style="display: flex; align-items: center; gap: var(--space);">
                                <button class="btn ${orderingEnabled ? 'btn-primary' : 'btn-ghost'}" onclick="toggleOrdering(${index})" style="min-width: 120px;">
                                    ${orderingEnabled ? '✅ Freigeschaltet' : '🔒 Gesperrt'}
                                </button>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">
                                    ${orderingEnabled ? 'Nutzer können bestellen' : 'Bestellungen sind gesperrt'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="field">
                            <label>✏️ Bestellbearbeitung erlauben</label>
                            <div style="display: flex; align-items: center; gap: var(--space);">
                                <button class="btn ${editingEnabled ? 'btn-secondary' : 'btn-ghost'}" onclick="toggleEditing(${index})" style="min-width: 120px;">
                                    ${editingEnabled ? '✏️ Erlaubt' : '🔒 Gesperrt'}
                                </button>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">
                                    ${editingEnabled ? 'Nutzer können Bestellungen bearbeiten' : 'Bestellbearbeitung ist gesperrt'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="field">
                            <label>👁️ Tag-Sichtbarkeit</label>
                            <div style="display: flex; align-items: center; gap: var(--space);">
                                <button class="btn ${dayVisible ? 'btn-primary' : 'btn-ghost'}" onclick="toggleDayVisibility(${index})" style="min-width: 120px;">
                                    ${dayVisible ? '👁️ Sichtbar' : '🙈 Versteckt'}
                                </button>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">
                                    ${dayVisible ? 'Tag ist für Nutzer sichtbar' : 'Tag ist für Nutzer versteckt'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="field">
                            <label>🗳️ Voting Management</label>
                            <div style="display: flex; align-items: center; gap: var(--space);">
                                <span style="color: var(--text-secondary);">${votesCount} Stimmen</span>
                                <button class="btn btn-ghost" onclick="clearVotes(${index})" ${votesCount === 0 ? 'disabled style="opacity: 0.5;"' : ''}>
                                    🗑️ Stimmen löschen
                                </button>
                            </div>
                        </div>
                        <div class="field">
                            <label>👤 Abholer</label>
                            <div style="display: flex; gap: var(--space-xs); align-items: center; margin-bottom: var(--space-xs);">
                                <select class="input" style="flex: 1;" onchange="selectSavedPerson(${index}, this.value)">
                                    <option value="">Person auswählen...</option>
                                    ${state.adminSettings.personsList.map(person => 
                                        `<option value="${person}" ${pickupPerson === person ? 'selected' : ''}>${person}</option>`
                                    ).join('')}
                                </select>
                                <button class="btn btn-ghost" onclick="savePerson(${index})" style="min-width: auto; padding: var(--space-xs);" title="Person speichern">💾</button>
                                <button class="btn btn-ghost" onclick="deleteSavedPerson(${index})" style="min-width: auto; padding: var(--space-xs);" title="Person löschen">🗑️</button>
                            </div>
                            <input type="text" class="input" value="${pickupPerson}" placeholder="Name des Abholers eingeben..." onchange="updatePickupPerson(${index}, this.value)">
                        </div>
                        <div class="field">
                            <label>💳 PayPal Code Bild</label>
                            <div style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-xs);">
                                <input type="file" class="input" accept="image/*" onchange="updatePayPalImage(${index}, this.files[0])" style="flex: 1;">
                                <button class="btn btn-ghost" onclick="deletePayPalImage(${index})" style="min-width: auto; padding: var(--space-xs);" title="Bild löschen" ${!paypalCode ? 'disabled' : ''}>🗑️</button>
                            </div>
                            <div class="paypal-preview">
                                ${paypalCode ? 
                                    `<img src="${paypalCode}" alt="PayPal Code für ${day}" style="max-width: 100%; height: auto; border-radius: var(--radius); border: 1px solid var(--border);">` : 
                                    `<div class="no-image" style="padding: var(--space-lg); text-align: center; color: var(--text-muted); border: 2px dashed var(--border); border-radius: var(--radius);">Noch kein PayPal-Code hochgeladen</div>`
                                }
                            </div>
                        </div>
                    </div>
                    <div class="pickup-stats">
                        <span>📦 Bestellungen heute:</span>
                        <span style="font-weight: 600; color: var(--primary);">${(state.orders[index] || []).length}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderRestaurantManagement() {
            const container = document.getElementById('restaurantManagement');
            container.innerHTML = '';

            state.restaurants.forEach(restaurant => {
                const card = document.createElement('div');
                card.className = 'restaurant-card';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space);">
                        <div>
                            <h4>${restaurant.name}</h4>
                            <p>${restaurant.category}</p>
                        </div>
                        <div style="display: flex; gap: var(--space-xs);">
                            <button onclick="editRestaurant('${restaurant.id}')" style="padding: 6px 12px; font-size: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Bearbeiten</button>
                            <button onclick="deleteRestaurant('${restaurant.id}')" style="padding: 6px 12px; font-size: 0.8rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Löschen</button>
                        </div>
                    </div>
                    <div class="menu-items">
                        <h5 style="margin: 0 0 var(--space-sm) 0; color: var(--text-primary);">Menü (${restaurant.menu.length} Artikel)</h5>
                        ${restaurant.menu.map(item => `
                            <div class="menu-item">
                                <span class="menu-item-name">${item.name}</span>
                                <div style="display: flex; gap: var(--space-xs); align-items: center;">
                                    <span class="menu-item-price">€${item.price.toFixed(2)}</span>
                                    <button onclick="editMenuItem('${restaurant.id}', '${item.id}')" style="padding: 2px 6px; font-size: 0.7rem; background: var(--primary); color: white; border: none; border-radius: 3px; cursor: pointer;">✏️</button>
                                    <button onclick="removeMenuItem('${restaurant.id}', '${item.id}')" style="padding: 2px 6px; font-size: 0.7rem; background: #ef4444; color: white; border: none; border-radius: 3px; cursor: pointer;">×</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-secondary" onclick="addMenuItem('${restaurant.id}')">+ Menü-Artikel hinzufügen</button>
                `;
                container.appendChild(card);
            });
        }

        function renderUserManagement() {
            const container = document.getElementById('userManagement');
            container.innerHTML = '';

            // Get all users from state.users (registered users) and active users
            const registeredUsers = state.users || {};
            const activeUserIds = new Set();
            
            // Get active users from votes, participants, and orders
            Object.values(state.votes).forEach(dayVotes => {
                Object.values(dayVotes).forEach(voters => {
                    if (Array.isArray(voters)) voters.forEach(userId => activeUserIds.add(userId));
                });
            });
            Object.values(state.participants).forEach(dayParticipants => {
                dayParticipants.forEach(userId => activeUserIds.add(userId));
            });
            Object.values(state.orders).forEach(dayOrders => {
                dayOrders.forEach(order => activeUserIds.add(order.userId));
            });

            // Combine registered users and active users
            const allUserIds = new Set([...Object.keys(registeredUsers), ...activeUserIds]);

            if (allUserIds.size === 0) {
                container.innerHTML = '<p class="text-muted">Noch keine Benutzer vorhanden</p>';
                return;
            }

            Array.from(allUserIds).forEach(userId => {
                const user = registeredUsers[userId];
                const userOrders = Object.values(state.orders).flat().filter(o => o.userId === userId);
                const totalSpent = userOrders.reduce((sum, order) => sum + order.total, 0);
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = '16px';
                
                // Get user info
                const userName = user?.name || userOrders[0]?.userName || userId;
                const userEmail = user?.email || 'Keine E-Mail';
                const isRegistered = !!user;
                
                card.innerHTML = `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <h4 style="margin: 0;">${userName}</h4>
                                    ${isRegistered ? 
                                        '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">Registriert</span>' : 
                                        '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">Nur aktiv</span>'
                                    }
                                </div>
                                <p class="text-muted" style="margin: 0; font-size: 0.875rem;">📧 ${userEmail}</p>
                                <p class="text-muted" style="margin: 0; font-size: 0.75rem;">ID: ${userId}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="color: var(--accent); font-weight: 600; margin: 0;">€${totalSpent.toFixed(2)}</p>
                                <p class="text-muted" style="font-size: 0.75rem; margin: 0;">${userOrders.length} Bestellungen</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${isRegistered ? 
                            `<button onclick="editUser('${userId}')" style="padding: 6px 12px; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Bearbeiten</button>
                             <button onclick="resetUserPassword('${userId}')" style="padding: 6px 12px; font-size: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">Passwort zurücksetzen</button>` :
                            `<button onclick="convertToRegisteredUser('${userId}')" style="padding: 6px 12px; font-size: 0.75rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Registrieren</button>`
                        }
                        <button onclick="deleteUser('${userId}')" style="padding: 6px 12px; font-size: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Löschen</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderOrderManagement() {
            const container = document.getElementById('orderManagement');
            const orderCountElement = document.getElementById('orderCount');
            const dateFilter = document.getElementById('orderDateFilter');
            container.innerHTML = '';

            let allOrders = Object.entries(state.orders).flatMap(([dayIndex, dayOrders]) =>
                dayOrders.map(order => ({ ...order, dayIndex: parseInt(dayIndex) }))
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Apply date filter if set
            if (dateFilter && dateFilter.value) {
                const filterDate = new Date(dateFilter.value);
                const filterDateStr = filterDate.toDateString();
                
                allOrders = allOrders.filter(order => {
                    const orderDate = new Date(order.timestamp);
                    return orderDate.toDateString() === filterDateStr;
                });
            }

            // Update order count
            if (orderCountElement) {
                const totalOrders = Object.entries(state.orders).flatMap(([dayIndex, dayOrders]) => dayOrders).length;
                const filteredCount = allOrders.length;
                
                if (dateFilter && dateFilter.value) {
                    orderCountElement.textContent = `${filteredCount} von ${totalOrders} Bestellungen`;
                } else {
                    orderCountElement.textContent = `${totalOrders} Bestellungen gesamt`;
                }
            }

            if (allOrders.length === 0) {
                const message = dateFilter && dateFilter.value ? 
                    'Keine Bestellungen für das ausgewählte Datum gefunden' : 
                    'Noch keine Bestellungen';
                container.innerHTML = `<p class="text-muted">${message}</p>`;
                return;
            }

            allOrders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = '16px';
                
                const dayName = state.weekDays[order.dayIndex] || 'Unbekannt';
                const orderDate = new Date(order.timestamp).toLocaleDateString('de-DE');
                
                const paymentStatus = state.orderStatuses[order.id] || 'pending';
                const statusColor = paymentStatus === 'paid' ? '#10b981' : '#f59e0b';
                const statusText = paymentStatus === 'paid' ? '✅ Bezahlt' : '⏳ Ausstehend';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <h4>${order.userName} - ${dayName}</h4>
                            <p class="text-muted">${orderDate} • #${order.id.slice(-6)}</p>
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="text-align: right;">
                            <p style="color: var(--accent); font-weight: 600;">€${order.total.toFixed(2)}</p>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end;">
                                ${paymentStatus === 'pending' ? 
                                    `<button onclick="togglePaymentStatus('${order.id}')" style="padding: 4px 8px; font-size: 0.75rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Als bezahlt markieren</button>` : 
                                    `<button onclick="togglePaymentStatus('${order.id}')" style="padding: 4px 8px; font-size: 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">Als ausstehend markieren</button>`
                                }
                                <button onclick="deleteOrder('${order.id}', ${order.dayIndex})" style="padding: 4px 8px; font-size: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Löschen</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid" style="gap: 4px;">
                        ${order.items.map(item => {
                            const extraWishes = item.extraWishes || [];
                            const extraWishesText = extraWishes.length > 0 
                                ? `<div style="font-size: 0.7rem; color: var(--text-accent); margin-top: 2px;">💬 ${extraWishes.join(', ')}</div>`
                                : '';
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; font-size: 0.875rem;">
                                    <div style="flex: 1;">
                                        <span>${item.quantity}x ${item.item.name}</span>
                                        ${extraWishesText}
                                    </div>
                                    <span>€${(item.item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderAdminSettings() {
            document.getElementById('adminUsersInput').value = state.adminSettings.allowedAdmins.join(', ');
        }

        // Admin action functions
        function updatePickupPerson(dayIndex, person) {
            state.adminSettings.pickupPersons[dayIndex] = person;
            saveState();
        }

        function updatePayPalImage(dayIndex, file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                state.adminSettings.paypalCodes[dayIndex] = e.target.result;
                saveState();
                renderPickupManagement(); // Refresh to show the image
            };
            reader.readAsDataURL(file);
        }

        // PayPal Code Bild löschen
        function deletePayPalImage(dayIndex) {
            if (confirm('PayPal-Code Bild wirklich löschen?')) {
                delete state.adminSettings.paypalCodes[dayIndex];
                saveState();
                renderPickupManagement();
            }
        }

        // Person mit Bild speichern
        function savePerson(dayIndex) {
            const personName = state.adminSettings.pickupPersons[dayIndex];
            const paypalImage = state.adminSettings.paypalCodes[dayIndex];
            
            if (!personName || !personName.trim()) {
                alert('Bitte zuerst einen Namen eingeben.');
                return;
            }
            
            if (!paypalImage) {
                alert('Bitte zuerst ein PayPal-Code Bild hochladen.');
                return;
            }
            
            // Person speichern
            state.adminSettings.savedPersons[personName] = paypalImage;
            
            // Zur Personenliste hinzufügen (falls noch nicht vorhanden)
            if (!state.adminSettings.personsList.includes(personName)) {
                state.adminSettings.personsList.push(personName);
            }
            
            saveState();
            alert(`Person "${personName}" mit PayPal-Code gespeichert!`);
            renderPickupManagement();
        }

        // Gespeicherte Person auswählen
        function selectSavedPerson(dayIndex, personName) {
            if (!personName) return;
            
            // Person setzen
            state.adminSettings.pickupPersons[dayIndex] = personName;
            
            // Gespeichertes Bild laden
            const savedImage = state.adminSettings.savedPersons[personName];
            if (savedImage) {
                state.adminSettings.paypalCodes[dayIndex] = savedImage;
            }
            
            saveState();
            renderPickupManagement();
        }

        // Gespeicherte Person löschen
        function deleteSavedPerson(dayIndex) {
            const personName = state.adminSettings.pickupPersons[dayIndex];
            
            if (!personName || !state.adminSettings.savedPersons[personName]) {
                alert('Keine gespeicherte Person zum Löschen gefunden.');
                return;
            }
            
            if (confirm(`Gespeicherte Person "${personName}" mit PayPal-Code wirklich löschen?`)) {
                // Aus gespeicherten Personen entfernen
                delete state.adminSettings.savedPersons[personName];
                
                // Aus Personenliste entfernen
                const index = state.adminSettings.personsList.indexOf(personName);
                if (index > -1) {
                    state.adminSettings.personsList.splice(index, 1);
                }
                
                saveState();
                alert(`Person "${personName}" wurde gelöscht.`);
                renderPickupManagement();
            }
        }

        // Bestellung bearbeiten
        function editOrder(orderId, dayIndex) {
            console.log('editOrder called with:', orderId, dayIndex);
            
            if (!state.currentUser) {
                alert('Sie müssen angemeldet sein, um Bestellungen zu bearbeiten.');
                return;
            }

            // Stelle sicher, dass orderHistory existiert
            if (!state.orderHistory) {
                state.orderHistory = {};
            }

            // Finde die Bestellung in der Bestellhistorie
            const userOrders = state.orderHistory[state.currentUser.id] || [];
            const order = userOrders.find(o => o.id === orderId);
            
            console.log('Found order in history:', order);
            
            if (!order) {
                alert('Bestellung nicht in der Bestellhistorie gefunden.');
                return;
            }

            // Stelle sicher, dass orders existiert
            if (!state.orders) {
                state.orders = {};
            }

            // Finde die Bestellung in den täglichen Bestellungen
            const dayOrders = state.orders[dayIndex] || [];
            const orderIndex = dayOrders.findIndex(o => o.id === orderId);
            
            console.log('Order index in day orders:', orderIndex);
            
            if (orderIndex === -1) {
                alert('Bestellung nicht mehr in den täglichen Bestellungen verfügbar.');
                return;
            }

            // Prüfe ob Bestellbearbeitung für diesen Tag erlaubt ist
            if (!isEditingEnabled(dayIndex)) {
                alert('Bestellbearbeitung für diesen Tag ist durch den Administrator gesperrt.');
                return;
            }

            // Lade die Bestellung zurück in den Warenkorb
            if (!state.cart[dayIndex]) state.cart[dayIndex] = {};
            
            // Lösche vorhandene Items im Warenkorb für diesen Tag
            state.cart[dayIndex] = {};
            
            // Füge Bestellungs-Items zum Warenkorb hinzu
            order.items.forEach(item => {
                if (item.item && item.item.id) {
                    state.cart[dayIndex][item.item.id] = {
                        quantity: item.quantity,
                        extraWishes: item.extraWishes || []
                    };
                }
            });

            // Entferne die alte Bestellung aus den täglichen Bestellungen
            dayOrders.splice(orderIndex, 1);
            
            // Entferne aus der Bestellhistorie
            const historyIndex = userOrders.findIndex(o => o.id === orderId);
            if (historyIndex > -1) {
                userOrders.splice(historyIndex, 1);
            }

            // Entferne auch den Bestellstatus
            if (state.orderStatuses && state.orderStatuses[orderId]) {
                delete state.orderStatuses[orderId];
            }

            saveState();
            
            // Gehe zur Voting-Seite und zeige das Menü
            showRoute('voting');
            setTimeout(() => {
                showMenu(dayIndex);
                updateCartSummary(dayIndex);
            }, 200);
            
            alert(`Bestellung wurde in den Warenkorb geladen (${order.items.length} Artikel). Sie können sie jetzt bearbeiten.`);
        }

        // Bestellung stornieren
        function cancelOrder(orderId, dayIndex) {
            if (!state.currentUser) {
                alert('Sie müssen angemeldet sein, um Bestellungen zu stornieren.');
                return;
            }

            if (!confirm('Bestellung wirklich stornieren? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                return;
            }

            // Finde die Bestellung in der Bestellhistorie
            const userOrders = state.orderHistory[state.currentUser.id] || [];
            const historyIndex = userOrders.findIndex(o => o.id === orderId);
            
            if (historyIndex === -1) {
                alert('Bestellung nicht gefunden.');
                return;
            }

            // Finde die Bestellung in den täglichen Bestellungen
            const dayOrders = state.orders[dayIndex] || [];
            const orderIndex = dayOrders.findIndex(o => o.id === orderId);
            
            // Entferne aus beiden Listen
            if (historyIndex > -1) {
                userOrders.splice(historyIndex, 1);
            }
            
            if (orderIndex > -1) {
                dayOrders.splice(orderIndex, 1);
            }

            // Entferne Zahlungsstatus
            delete state.orderStatuses[orderId];

            saveState();
            alert('Bestellung wurde erfolgreich storniert.');
            renderOrderHistory();
        }

        function deleteRestaurant(restaurantId) {
            if (confirm('Restaurant wirklich löschen?')) {
                state.restaurants = state.restaurants.filter(r => r.id !== restaurantId);
                saveState();
                renderRestaurantManagement();
            }
        }

        function addMenuItem(restaurantId) {
            const name = prompt('Name des Menü-Artikels:');
            const price = parseFloat(prompt('Preis (€):'));
            
            if (name && !isNaN(price)) {
                const restaurant = state.restaurants.find(r => r.id === restaurantId);
                if (restaurant) {
                    restaurant.menu.push({
                        id: 'm' + Date.now(),
                        name: name,
                        price: price
                    });
                    saveState();
                    renderRestaurantManagement();
                }
            }
        }

        function editMenuItem(restaurantId, itemId) {
            const restaurant = state.restaurants.find(r => r.id === restaurantId);
            if (!restaurant) return;
            
            const item = restaurant.menu.find(m => m.id === itemId);
            if (!item) return;
            
            const newName = prompt('Name des Menü-Artikels:', item.name);
            const newPrice = parseFloat(prompt('Preis (€):', item.price));
            
            if (newName && !isNaN(newPrice)) {
                item.name = newName;
                item.price = newPrice;
                saveState();
                renderRestaurantManagement();
                alert('Menü-Artikel wurde aktualisiert');
            }
        }

        function deleteOrder(orderId, dayIndex) {
            if (confirm('Bestellung wirklich löschen?')) {
                const dayOrders = state.orders[dayIndex] || [];
                const orderIndex = dayOrders.findIndex(o => o.id === orderId);
                if (orderIndex > -1) {
                    const order = dayOrders[orderIndex];
                    dayOrders.splice(orderIndex, 1);
                    
                    // Also remove from user history
                    const userHistory = state.orderHistory[order.userId] || [];
                    const historyIndex = userHistory.findIndex(o => o.id === orderId);
                    if (historyIndex > -1) {
                        userHistory.splice(historyIndex, 1);
                    }
                    
                    saveState();
                    renderOrderManagement();
                }
            }
        }

        // PayPal Modal with Payment Confirmation
        function showPayPalModal(dayIndex, orderId, totalAmount = null) {
            const paypalImage = state.adminSettings.paypalCodes[dayIndex];
            const pickupPerson = state.adminSettings.pickupPersons[dayIndex];
            
            // Find the order to get the total amount if not provided
            let orderTotal = totalAmount;
            if (!orderTotal) {
                const dayOrders = state.orders[dayIndex] || [];
                const order = dayOrders.find(o => o.id === orderId);
                orderTotal = order ? order.total : 0;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                display: flex; align-items: center; justify-content: center; 
                z-index: 1000; backdrop-filter: blur(8px);
            `;
            modal.innerHTML = `
                <div style="background: var(--surface); padding: var(--space-xl); border-radius: var(--radius-lg); max-width: 90vw; max-height: 90vh; overflow: auto; border: 1px solid var(--border); box-shadow: var(--shadow-lg);">
                    <div style="text-align: center; margin-bottom: var(--space-lg);">
                        <h3 style="margin: 0 0 var(--space) 0; color: var(--text-primary); font-size: 1.5rem;">💳 PayPal Zahlung</h3>
                        <p style="color: var(--text-muted); margin: 0;">Scanne den QR-Code für ${state.weekDays[dayIndex]}</p>
                        <div style="background: var(--primary); color: white; padding: var(--space); border-radius: var(--radius); margin: var(--space) auto; font-size: 1.25rem; font-weight: bold; max-width: 200px;">
                            Betrag: €${orderTotal.toFixed(2)}
                        </div>
                        ${pickupPerson ? `<p style="color: var(--text-muted); margin: var(--space-xs) 0 0 0;">Abholung: <strong>${pickupPerson}</strong></p>` : ''}
                    </div>
                    <div style="text-align: center; margin-bottom: var(--space-lg);">
                        <img src="${paypalImage}" alt="PayPal QR Code" style="max-width: 100%; height: auto; border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    </div>
                    <div style="display: flex; gap: var(--space); justify-content: center; flex-wrap: wrap;">
                        <button onclick="markAsPaid('${orderId}'); this.parentElement.parentElement.parentElement.remove();" 
                                style="padding: var(--space) var(--space-lg); background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 1rem;">
                            ✅ Bezahlt
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="padding: var(--space) var(--space-lg); background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-weight: 500;">
                            Später bezahlen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Modal für Extrawünsche beim Hinzufügen zum Warenkorb
        function showAddToCartModal(itemId, restaurantId, dayIndex) {
            console.log('showAddToCartModal called with:', itemId, restaurantId, dayIndex);
            
            // Entferne vorheriges Modal falls vorhanden
            const existingModal = document.getElementById('addToCartModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            console.log('Available restaurants:', state.restaurants);
            const restaurant = state.restaurants.find(r => r.id === restaurantId);
            console.log('Found restaurant:', restaurant);
            const item = restaurant?.menu.find(i => i.id === itemId);
            console.log('Found item:', item);
            
            if (!item) {
                alert('Artikel nicht gefunden');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'addToCartModal';
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                display: flex; align-items: center; justify-content: center; 
                z-index: 1000; backdrop-filter: blur(8px);
            `;
            
            modal.innerHTML = `
                <div style="background: var(--surface); padding: var(--space-xl); border-radius: var(--radius-lg); max-width: 500px; width: 90vw; border: 1px solid var(--border); box-shadow: var(--shadow-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="margin: 0; color: var(--text-primary);">🍽️ Zum Warenkorb hinzufügen</h3>
                        <button onclick="closeAddToCartModal(this)" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <h4 style="margin: 0 0 var(--space-xs) 0; color: var(--text-primary);">${item.name}</h4>
                        <p style="margin: 0 0 var(--space-xs) 0; color: var(--text-muted);">${restaurant.name}</p>
                        <p style="margin: 0; color: var(--accent); font-weight: 600;">€${item.price.toFixed(2)}</p>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
                            💬 Extrawunsch (optional)
                        </label>
                        <textarea 
                            id="extraWishText" 
                            placeholder="z.B. ohne Zwiebeln, extra scharf, mit Pommes statt Reis..."
                            style="width: 100%; min-height: 80px; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); font-family: inherit; resize: vertical;"
                        ></textarea>
                        <small style="color: var(--text-muted); font-size: 0.875rem;">
                            Teilen Sie dem Restaurant Ihre besonderen Wünsche mit
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-sm); justify-content: flex-end;">
                        <button class="btn btn-ghost" onclick="closeAddToCartModal(this)">
                            Abbrechen
                        </button>
                        <button class="btn btn-primary" onclick="handleAddToCartFromModal('${itemId}', '${restaurantId}', ${dayIndex}, this);">
                            Zum Warenkorb
                        </button>
                    </div>
                </div>
            `;
            
            // Klick auf Hintergrund schließt Modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAddToCartModal();
                }
            });
            
            document.body.appendChild(modal);
            
            // Handler ist jetzt global definiert
            
            // Focus auf das Textfeld setzen
            setTimeout(() => {
                const textField = document.getElementById('extraWishText');
                if (textField) textField.focus();
            }, 100);
        }

        // Modal schließen
        function closeAddToCartModal(button) {
            const modal = document.getElementById('addToCartModal');
            if (modal) {
                modal.remove();
            } else {
                // Fallback: suche nach Modal über Button
                const fallbackModal = button ? button.closest('[style*="position: fixed"]') : null;
                if (fallbackModal) {
                    fallbackModal.remove();
                }
            }
        }

        // Extrawünsche bearbeiten
        function editExtraWishes(itemId, dayIndex) {
            if (!state.currentUser) return;
            
            const userCart = getUserCart();
            const cart = userCart[dayIndex] || {};
            const cartItem = cart[itemId];
            
            if (!cartItem) {
                alert('Artikel nicht im Warenkorb gefunden.');
                return;
            }
            
            const item = findMenuItem(itemId);
            if (!item) {
                alert('Artikel nicht gefunden.');
                return;
            }
            
            const extraWishes = typeof cartItem === 'object' ? (cartItem.extraWishes || []) : [];
            
            // Entferne vorheriges Modal falls vorhanden
            const existingModal = document.getElementById('editExtraWishesModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'editExtraWishesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--surface);
                    border: 1px solid var(--border);
                    border-radius: var(--radius-lg);
                    padding: var(--space-lg);
                    width: 90%;
                    max-width: 500px;
                    backdrop-filter: blur(20px);
                    box-shadow: var(--shadow-lg);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="margin: 0; color: var(--text-primary);">✏️ Extrawünsche bearbeiten</h3>
                        <button onclick="closeEditExtraWishesModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <h4 style="margin: 0 0 var(--space-xs) 0; color: var(--text-primary);">${item.name}</h4>
                        <p style="margin: 0 0 var(--space-lg) 0; color: var(--text-muted);">€${item.price.toFixed(2)}</p>
                        
                        <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
                            Aktuelle Extrawünsche:
                        </label>
                        <div id="extraWishesContainer" style="margin-bottom: var(--space-lg);">
                            ${extraWishes.length === 0 ? '<p style="color: var(--text-muted); font-style: italic;">Keine Extrawünsche</p>' : ''}
                        </div>
                        
                        <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
                            Neuen Extrawunsch hinzufügen:
                        </label>
                        <textarea 
                            id="newExtraWishText" 
                            placeholder="z.B. Ohne Zwiebeln, extra scharf, ..." 
                            style="
                                width: 100%;
                                min-height: 60px;
                                padding: var(--space);
                                border: 1px solid var(--border);
                                border-radius: var(--radius);
                                background: var(--surface);
                                color: var(--text-primary);
                                font-family: inherit;
                                resize: vertical;
                            "
                        ></textarea>
                    </div>
                    
                    <div style="display: flex; gap: var(--space); justify-content: flex-end;">
                        <button class="btn btn-ghost" onclick="closeEditExtraWishesModal()">
                            Abbrechen
                        </button>
                        <button class="btn btn-secondary" onclick="addNewExtraWish('${itemId}', ${dayIndex})">
                            Hinzufügen
                        </button>
                        <button class="btn btn-primary" onclick="saveExtraWishes('${itemId}', ${dayIndex})">
                            Speichern
                        </button>
                    </div>
                </div>
            `;
            
            // Event Listener für Klick außerhalb des Modals
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeEditExtraWishesModal();
                }
            });
            
            document.body.appendChild(modal);
            
            // Extrawünsche anzeigen
            renderExtraWishesList(extraWishes, itemId, dayIndex);
        }

        function renderExtraWishesList(extraWishes, itemId, dayIndex) {
            const container = document.getElementById('extraWishesContainer');
            if (!container) return;
            
            if (extraWishes.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-style: italic;">Keine Extrawünsche</p>';
                return;
            }
            
            container.innerHTML = extraWishes.map((wish, index) => `
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: var(--space-xs) var(--space);
                    background: var(--background);
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    margin-bottom: var(--space-xs);
                ">
                    <span style="flex: 1; color: var(--text-primary);">${wish}</span>
                    <button 
                        class="btn btn-ghost" 
                        style="padding: 2px 6px; font-size: 0.75rem; color: #ef4444;" 
                        onclick="removeExtraWish('${itemId}', ${dayIndex}, ${index})"
                        title="Extrawunsch löschen"
                    >
                        🗑️
                    </button>
                </div>
            `).join('');
        }

        function addNewExtraWish(itemId, dayIndex) {
            const newWishInput = document.getElementById('newExtraWishText');
            const newWish = newWishInput.value.trim();
            
            if (!newWish) {
                alert('Bitte einen Extrawunsch eingeben.');
                return;
            }
            
            const cart = state.cart[dayIndex] || {};
            const cartItem = cart[itemId];
            
            if (!cartItem) return;
            
            // Stelle sicher, dass cartItem ein Objekt ist
            if (typeof cartItem === 'number') {
                state.cart[dayIndex][itemId] = { quantity: cartItem, extraWishes: [] };
            }
            
            if (!state.cart[dayIndex][itemId].extraWishes) {
                state.cart[dayIndex][itemId].extraWishes = [];
            }
            
            // Füge neuen Wunsch hinzu
            state.cart[dayIndex][itemId].extraWishes.push(newWish);
            
            // Input leeren
            newWishInput.value = '';
            
            // Liste aktualisieren
            renderExtraWishesList(state.cart[dayIndex][itemId].extraWishes, itemId, dayIndex);
        }

        function removeExtraWish(itemId, dayIndex, wishIndex) {
            const cart = state.cart[dayIndex] || {};
            const cartItem = cart[itemId];
            
            if (!cartItem || typeof cartItem !== 'object' || !cartItem.extraWishes) return;
            
            if (confirm('Extrawunsch wirklich löschen?')) {
                cartItem.extraWishes.splice(wishIndex, 1);
                renderExtraWishesList(cartItem.extraWishes, itemId, dayIndex);
            }
        }

        function saveExtraWishes(itemId, dayIndex) {
            saveState();
            updateCartSummary(dayIndex);
            closeEditExtraWishesModal();
            showNotification('✅ Extrawünsche wurden gespeichert!', 'success');
        }

        function closeEditExtraWishesModal() {
            const modal = document.getElementById('editExtraWishesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Extrawünsche aus Bestellhistorie anzeigen
        function viewExtraWishes(orderId, itemId, itemName, extraWishes) {
            // Entferne vorheriges Modal falls vorhanden
            const existingModal = document.getElementById('viewExtraWishesModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'viewExtraWishesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(8px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--surface);
                    border: 1px solid var(--border);
                    border-radius: var(--radius-lg);
                    padding: var(--space-lg);
                    width: 90%;
                    max-width: 400px;
                    backdrop-filter: blur(20px);
                    box-shadow: var(--shadow-lg);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="margin: 0; color: var(--text-primary);">💬 Extrawünsche</h3>
                        <button onclick="closeViewExtraWishesModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <h4 style="margin: 0 0 var(--space-xs) 0; color: var(--text-primary);">${itemName}</h4>
                        <p style="margin: 0 0 var(--space-lg) 0; color: var(--text-muted); font-size: 0.75rem;">Bestellung #${orderId.slice(-6)}</p>
                        
                        <div style="margin-bottom: var(--space-lg);">
                            ${extraWishes.map(wish => `
                                <div style="
                                    padding: var(--space-xs) var(--space);
                                    background: var(--background);
                                    border: 1px solid var(--border);
                                    border-radius: var(--radius);
                                    margin-bottom: var(--space-xs);
                                    color: var(--text-primary);
                                ">
                                    ${wish}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space); justify-content: flex-end;">
                        <button class="btn btn-primary" onclick="closeViewExtraWishesModal()">
                            Schließen
                        </button>
                    </div>
                </div>
            `;
            
            // Event Listener für Klick außerhalb des Modals
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeViewExtraWishesModal();
                }
            });
            
            document.body.appendChild(modal);
        }

        function closeViewExtraWishesModal() {
            const modal = document.getElementById('viewExtraWishesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Passwort ändern Modal
        function showChangePasswordModal() {
            if (!state.currentUser) {
                alert('Sie müssen angemeldet sein, um das Passwort zu ändern.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'changePasswordModal';
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                display: flex; align-items: center; justify-content: center; 
                z-index: 1000; backdrop-filter: blur(8px);
            `;
            
            modal.innerHTML = `
                <div style="background: var(--surface); padding: var(--space-xl); border-radius: var(--radius-lg); max-width: 500px; width: 90vw; border: 1px solid var(--border); box-shadow: var(--shadow-lg);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="margin: 0; color: var(--text-primary);">🔒 Passwort ändern</h3>
                        <button onclick="closeChangePasswordModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    
                    <form id="changePasswordForm" style="display: flex; flex-direction: column; gap: var(--space-lg);">
                        <div>
                            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
                                Aktuelles Passwort
                            </label>
                            <input type="password" id="currentPassword" required
                                style="width: 100%; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
                                Neues Passwort
                            </label>
                            <input type="password" id="newPassword" required minlength="6"
                                style="width: 100%; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
                            <small style="color: var(--text-muted); font-size: 0.875rem;">Mindestens 6 Zeichen</small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--text-primary);">
                                Neues Passwort bestätigen
                            </label>
                            <input type="password" id="confirmPassword" required
                                style="width: 100%; padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        
                        <div style="display: flex; gap: var(--space-sm); justify-content: flex-end;">
                            <button type="button" class="btn btn-ghost" onclick="closeChangePasswordModal()">
                                Abbrechen
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Passwort ändern
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Form Event Listener
            document.getElementById('changePasswordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handlePasswordChange();
            });
            
            // Focus auf erstes Feld
            setTimeout(() => {
                document.getElementById('currentPassword').focus();
            }, 100);
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.remove();
            }
        }

        function handlePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validierung
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Die neuen Passwörter stimmen nicht überein.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Das neue Passwort muss mindestens 6 Zeichen lang sein.');
                return;
            }
            
            // Aktuelles Passwort prüfen
            const user = state.users[state.currentUser.id];
            if (!user || user.password !== currentPassword) {
                alert('Das aktuelle Passwort ist falsch.');
                return;
            }
            
            // Passwort ändern
            user.password = newPassword;
            saveState();
            
            alert('✅ Passwort erfolgreich geändert!');
            closeChangePasswordModal();
        }

        // Mark order as paid
        function markAsPaid(orderId) {
            state.orderStatuses[orderId] = 'paid';
            saveState();
            alert('✅ Bestellung als bezahlt markiert!');
            // Refresh UI if on admin page
            if (window.location.hash === '#/admin') {
                renderOrderManagement();
            }
        }

        // Toggle payment status
        function togglePaymentStatus(orderId) {
            const currentStatus = state.orderStatuses[orderId] || 'pending';
            state.orderStatuses[orderId] = currentStatus === 'paid' ? 'pending' : 'paid';
            saveState();
            renderOrderManagement();
        }

        // Date filter functions
        function clearOrderDateFilter() {
            const dateFilter = document.getElementById('orderDateFilter');
            if (dateFilter) {
                dateFilter.value = '';
                renderOrderManagement();
            }
        }

        // Event listener for date filter
        function initOrderDateFilter() {
            const dateFilter = document.getElementById('orderDateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', renderOrderManagement);
            }
        }

        // User Management Functions
        function addNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            
            if (!name || !email) {
                alert('Bitte Name und E-Mail eingeben');
                return;
            }
            
            // Check if email already exists
            if (state.users && Object.values(state.users).some(user => user.email === email)) {
                alert('E-Mail bereits vergeben');
                return;
            }
            
            // Initialize users object if not exists
            if (!state.users) {
                state.users = {};
            }
            
            const userId = 'u' + Date.now();
            state.users[userId] = {
                id: userId,
                name: name,
                email: email,
                password: '12345678', // Default password
                createdAt: new Date().toISOString()
            };
            
            // Clear inputs
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            
            saveState();
            renderUserManagement();
            alert(`Benutzer ${name} wurde erstellt. Standard-Passwort: 12345678`);
        }

        function editUser(userId) {
            const user = state.users[userId];
            if (!user) return;
            
            const newName = prompt('Neuer Name:', user.name);
            const newEmail = prompt('Neue E-Mail:', user.email);
            
            if (newName && newEmail) {
                // Check if new email already exists (except for current user)
                if (Object.values(state.users).some(u => u.email === newEmail && u.id !== userId)) {
                    alert('E-Mail bereits vergeben');
                    return;
                }
                
                state.users[userId].name = newName;
                state.users[userId].email = newEmail;
                saveState();
                renderUserManagement();
                alert('Benutzer aktualisiert');
            }
        }

        function resetUserPassword(userId) {
            const user = state.users[userId];
            if (!user) return;
            
            if (confirm(`Passwort für ${user.name} auf 12345678 zurücksetzen?`)) {
                state.users[userId].password = '12345678';
                saveState();
                alert(`Passwort für ${user.name} wurde zurückgesetzt: 12345678`);
            }
        }

        function convertToRegisteredUser(userId) {
            // Get user info from orders or other sources
            const userOrders = Object.values(state.orders).flat().filter(o => o.userId === userId);
            const userName = userOrders[0]?.userName || userId;
            
            const name = prompt('Name des Benutzers:', userName);
            const email = prompt('E-Mail Adresse:');
            
            if (name && email) {
                // Check if email already exists
                if (state.users && Object.values(state.users).some(user => user.email === email)) {
                    alert('E-Mail bereits vergeben');
                    return;
                }
                
                // Initialize users object if not exists
                if (!state.users) {
                    state.users = {};
                }
                
                state.users[userId] = {
                    id: userId,
                    name: name,
                    email: email,
                    password: '12345678',
                    createdAt: new Date().toISOString()
                };
                
                saveState();
                renderUserManagement();
                alert(`Benutzer ${name} wurde registriert. Standard-Passwort: 12345678`);
            }
        }

        function deleteUser(userId) {
            const user = state.users?.[userId];
            const userOrders = Object.values(state.orders).flat().filter(o => o.userId === userId);
            const userName = user?.name || userOrders[0]?.userName || userId;
            
            if (confirm(`Benutzer ${userName} wirklich löschen? Dies entfernt auch alle Bestellungen und Aktivitäten.`)) {
                // Remove from registered users
                if (state.users?.[userId]) {
                    delete state.users[userId];
                }
                
                // Remove from all orders
                Object.keys(state.orders).forEach(dayIndex => {
                    state.orders[dayIndex] = state.orders[dayIndex].filter(order => order.userId !== userId);
                });
                
                // Remove from participants
                Object.keys(state.participants).forEach(dayIndex => {
                    state.participants[dayIndex] = state.participants[dayIndex].filter(id => id !== userId);
                });
                
                // Remove from votes
                Object.keys(state.votes).forEach(dayIndex => {
                    Object.keys(state.votes[dayIndex]).forEach(restaurantId => {
                        if (Array.isArray(state.votes[dayIndex][restaurantId])) {
                            state.votes[dayIndex][restaurantId] = state.votes[dayIndex][restaurantId].filter(id => id !== userId);
                        }
                    });
                });
                
                // Remove from order history
                if (state.orderHistory?.[userId]) {
                    delete state.orderHistory[userId];
                }
                
                // Remove from order statuses
                Object.keys(state.orderStatuses).forEach(orderId => {
                    const orderExists = Object.values(state.orders).flat().some(order => order.id === orderId);
                    if (!orderExists) {
                        delete state.orderStatuses[orderId];
                    }
                });
                
                saveState();
                renderUserManagement();
                alert(`Benutzer ${userName} wurde gelöscht`);
            }
        }

        // Add new restaurant
        function addNewRestaurant() {
            const name = prompt('Restaurant Name:');
            const category = prompt('Kategorie (z.B. Italienisch, Sushi, etc.):');
            
            if (name && category) {
                const newRestaurant = {
                    id: 'r' + Date.now(),
                    name: name,
                    category: category,
                    menu: []
                };
                state.restaurants.push(newRestaurant);
                saveState();
                renderRestaurantManagement();
            }
        }

        // Edit restaurant
        function editRestaurant(restaurantId) {
            const restaurant = state.restaurants.find(r => r.id === restaurantId);
            if (restaurant) {
                const newName = prompt('Restaurant Name:', restaurant.name);
                const newCategory = prompt('Kategorie:', restaurant.category);
                
                if (newName && newCategory) {
                    restaurant.name = newName;
                    restaurant.category = newCategory;
                    saveState();
                    renderRestaurantManagement();
                }
            }
        }

        // Remove menu item
        function removeMenuItem(restaurantId, itemId) {
            if (confirm('Menü-Artikel wirklich löschen?')) {
                const restaurant = state.restaurants.find(r => r.id === restaurantId);
                if (restaurant) {
                    restaurant.menu = restaurant.menu.filter(item => item.id !== itemId);
                    saveState();
                    renderRestaurantManagement();
                }
            }
        }

        // Global handler function für Modal-Button
        function handleAddToCartFromModal(itemId, restaurantId, dayIndex, button) {
            console.log('🔥 handleAddToCartFromModal called with:', itemId, restaurantId, dayIndex);
            console.log('🔥 Button element:', button);
            
            try {
                const extraWishTextElement = document.getElementById('extraWishText');
                console.log('🔥 extraWishTextElement found:', extraWishTextElement);
                const extraWish = extraWishTextElement ? extraWishTextElement.value : '';
                console.log('🔥 Extra wish value:', extraWish);
                
                console.log('🔥 Calling addToCartWithWish...');
                addToCartWithWish(itemId, restaurantId, dayIndex, extraWish);
                console.log('🔥 addToCartWithWish completed');
                
                console.log('🔥 Closing modal...');
                closeAddToCartModal(button);
                console.log('🔥 Modal closed');
                
            } catch (error) {
                console.error('🔥 Error in handleAddToCartFromModal:', error);
                alert('Fehler beim Hinzufügen zum Warenkorb: ' + error.message);
            }
        }

        // Make functions global for onclick handlers
        window.vote = vote;
        window.joinDay = joinDay;
        window.showMenu = showMenu;
        window.addToCart = addToCart;
        window.addToCartWithWish = addToCartWithWish;
        window.showAddToCartModal = showAddToCartModal;
        window.closeAddToCartModal = closeAddToCartModal;
        window.handleAddToCartFromModal = handleAddToCartFromModal;
        window.getUserCart = getUserCart;
        window.editExtraWishes = editExtraWishes;
        window.closeEditExtraWishesModal = closeEditExtraWishesModal;
        window.addNewExtraWish = addNewExtraWish;
        window.removeExtraWish = removeExtraWish;
        window.saveExtraWishes = saveExtraWishes;
        window.viewExtraWishes = viewExtraWishes;
        window.closeViewExtraWishesModal = closeViewExtraWishesModal;
        window.showChangePasswordModal = showChangePasswordModal;
        window.closeChangePasswordModal = closeChangePasswordModal;
        window.removeFromCart = removeFromCart;
        window.clearCart = clearCart;
        window.placeOrder = placeOrder;
        window.editOrder = editOrder;
        window.updatePickupPerson = updatePickupPerson;
        window.updatePayPalImage = updatePayPalImage;
        window.deleteRestaurant = deleteRestaurant;
        window.addMenuItem = addMenuItem;
        window.deleteOrder = deleteOrder;
        window.showPayPalModal = showPayPalModal;
        window.markAsPaid = markAsPaid;
        window.togglePaymentStatus = togglePaymentStatus;
        window.addNewRestaurant = addNewRestaurant;
        window.editRestaurant = editRestaurant;
        window.removeMenuItem = removeMenuItem;

        // Helper functions
        function isOrderingEnabled(dayIndex) {
            return state.adminSettings.orderingEnabled[dayIndex] === true;
        }

        function toggleOrdering(dayIndex) {
            state.adminSettings.orderingEnabled[dayIndex] = !state.adminSettings.orderingEnabled[dayIndex];
            saveState();
            renderPickupManagement();
            // Update any open voting pages
            if (state.currentRoute === 'voting') {
                renderWeekGrid();
            }
        }

        function toggleEditing(dayIndex) {
            state.adminSettings.editingEnabled[dayIndex] = !state.adminSettings.editingEnabled[dayIndex];
            saveState();
            renderPickupManagement();
            // Update any open voting pages
            if (state.currentRoute === 'voting') {
                renderWeekGrid();
            }
        }

        function isEditingEnabled(dayIndex) {
            return state.adminSettings.editingEnabled[dayIndex] === true;
        }

        function toggleDayVisibility(dayIndex) {
            // Ensure structure exists
            if (!state.adminSettings) {
                state.adminSettings = {};
            }
            if (!state.adminSettings.daysVisible) {
                state.adminSettings.daysVisible = { 0: true, 1: true, 2: true, 3: true, 4: true };
            }
            
            // Toggle visibility
            state.adminSettings.daysVisible[dayIndex] = !state.adminSettings.daysVisible[dayIndex];
            saveState();
            
            // Update UI
            renderPickupManagement();
            if (state.currentRoute === 'voting') {
                renderWeekGrid();
            }
            
            // Show notification
            const dayName = state.weekDays[dayIndex] || `Tag ${dayIndex}`;
            const isVisible = state.adminSettings.daysVisible[dayIndex];
            showNotification(
                `${dayName} ${isVisible ? '👁️ sichtbar' : '🙈 versteckt'} gemacht!`,
                'success'
            );
        }

        function isDayVisible(dayIndex) {
            if (!state.adminSettings || !state.adminSettings.daysVisible) {
                return true; // Fallback: Alle Tage sichtbar wenn nicht konfiguriert
            }
            return state.adminSettings.daysVisible[dayIndex] === true;
        }

        function toggleAllOrdering(enable) {
            const action = enable ? 'freischalten' : 'sperren';
            if (confirm(`Bestellungen für alle Wochentage ${action}?`)) {
                // Toggle all days (0-4 = Monday-Friday)
                for (let i = 0; i < 5; i++) {
                    state.adminSettings.orderingEnabled[i] = enable;
                }
                saveState();
                renderPickupManagement();
                // Update any open voting pages
                if (state.currentRoute === 'voting') {
                    renderWeekGrid();
                }
                
                const message = enable ? 
                    '✅ Bestellungen für alle Wochentage freigeschaltet!' : 
                    '🔒 Bestellungen für alle Wochentage gesperrt!';
                alert(message);
            }
        }

        function clearVotes(dayIndex) {
            if (confirm(`Alle Stimmen für ${state.weekDays[dayIndex]} löschen?`)) {
                if (state.votes[dayIndex]) {
                    state.votes[dayIndex] = {};
                    saveState();
                    renderAdmin();
                    if (state.currentRoute === 'voting') {
                        renderWeekGrid();
                    }
                }
            }
        }

        // Restaurant selection functions
        function getDailyRestaurants(dayIndex) {
            // Ensure adminSettings exists
            if (!state.adminSettings) {
                state.adminSettings = { dailyRestaurants: {} };
            }
            if (!state.adminSettings.dailyRestaurants) {
                state.adminSettings.dailyRestaurants = {};
            }
            
            const dailyRestaurantIds = state.adminSettings.dailyRestaurants[dayIndex];
            if (dailyRestaurantIds && Array.isArray(dailyRestaurantIds) && dailyRestaurantIds.length > 0) {
                const selectedRestaurants = state.restaurants.filter(r => dailyRestaurantIds.includes(r.id));
                if (selectedRestaurants.length > 0) {
                    return selectedRestaurants;
                }
            }
            // Default: show first 4 restaurants if none selected
            return state.restaurants.slice(0, 4);
        }

        function showRestaurantSelector(dayIndex) {
            const currentSelection = state.adminSettings.dailyRestaurants[dayIndex] || [];
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
                display: flex; align-items: center; justify-content: center; 
                z-index: 1000; backdrop-filter: blur(8px);
            `;
            
            modal.innerHTML = `
                <div style="background: var(--surface); padding: var(--space-xl); border-radius: var(--radius-lg); max-width: 90vw; max-height: 90vh; overflow: auto; border: 1px solid var(--border); box-shadow: var(--shadow-lg); width: 600px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="margin: 0; color: var(--text-primary);">🏪 Restaurants für ${state.weekDays[dayIndex]} auswählen</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: var(--space-lg);">Wähle 3-5 Restaurants für das Voting aus:</p>
                    <div id="restaurantCheckboxes" style="display: grid; gap: var(--space-sm); max-height: 400px; overflow-y: auto;">
                        ${state.restaurants.map(restaurant => `
                            <label style="display: flex; align-items: center; gap: var(--space); padding: var(--space-sm); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; background: var(--surface-hover);">
                                <input type="checkbox" ${currentSelection.includes(restaurant.id) ? 'checked' : ''} 
                                       value="${restaurant.id}" style="margin: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary);">${restaurant.name}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">${restaurant.category}</div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    <div style="display: flex; gap: var(--space); justify-content: flex-end; margin-top: var(--space-lg);">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="padding: var(--space) var(--space-lg); background: var(--surface-hover); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer;">
                            Abbrechen
                        </button>
                        <button onclick="saveRestaurantSelection(${dayIndex}); this.parentElement.parentElement.parentElement.remove();" 
                                style="padding: var(--space) var(--space-lg); background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">
                            Speichern
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function saveRestaurantSelection(dayIndex) {
            const checkboxes = document.querySelectorAll('#restaurantCheckboxes input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('Bitte wähle mindestens ein Restaurant aus.');
                return;
            }
            
            if (selectedIds.length > 6) {
                alert('Bitte wähle maximal 6 Restaurants aus.');
                return;
            }
            
            state.adminSettings.dailyRestaurants[dayIndex] = selectedIds;
            saveState();
            renderWeekGrid();
        }

        window.isOrderingEnabled = isOrderingEnabled;
        window.toggleOrdering = toggleOrdering;
        window.toggleEditing = toggleEditing;
        window.toggleDayVisibility = toggleDayVisibility;
        window.toggleAllOrdering = toggleAllOrdering;
        window.clearVotes = clearVotes;
        window.getDailyRestaurants = getDailyRestaurants;
        window.showRestaurantSelector = showRestaurantSelector;
        window.saveRestaurantSelection = saveRestaurantSelection;
    </script>
</body>
</html>
